var MAPJS={},observable=function(a){"use strict";var b=[];return a.addEventListener=function(a,c,d){a.split(" ").forEach(function(a){a&&b.push({type:a,listener:c,priority:d||0})})},a.listeners=function(a){return b.filter(function(b){return b.type===a}).map(function(a){return a.listener})},a.removeEventListener=function(a,c){b=b.filter(function(a){return a.listener!==c})},a.dispatchEvent=function(a){var c=Array.prototype.slice.call(arguments,1);b.filter(function(b){return b.type===a}).sort(function(a,b){return b.priority-a.priority}).some(function(a){try{return a.listener.apply(void 0,c)===!1}catch(b){console.log("dispatchEvent failed",b,a)}})},a};if(MAPJS.URLHelper={urlPattern:/(https?:\/\/|www\.)[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/i,containsLink:function(a){"use strict";return MAPJS.URLHelper.urlPattern.test(a)},getLink:function(a){"use strict";var b=a.match(MAPJS.URLHelper.urlPattern);return b&&b[0]&&(b=b[0],/https?:\/\//i.test(b)||(b="http://"+b)),b},stripLink:function(a){"use strict";return a.replace(MAPJS.URLHelper.urlPattern,"")}},MAPJS.content=function(a,b){"use strict";var c,d=function(){c=void 0},e=function z(b){return b=b||a,b.ideas?_.reduce(b.ideas,function(a,b){return Math.max(a,z(b))},parseInt(b.id,10)||0):parseInt(b.id,10)||0},f=function(a){return a=a||b,c||(c=e()),c+=1,a?c+"."+a:c},g=function(a,b){return a.id?d():a.id=f(b),a.ideas&&_.each(a.ideas,function(c,d){a.ideas[parseFloat(d)]=g(c,b)}),a.title||(a.title=""),a.containsDirectChild=a.findChildRankById=function(b){return parseFloat(_.reduce(a.ideas,function(a,c,d){return c.id==b?d:a},void 0))},a.findSubIdeaById=function(b){var c=_.find(a.ideas,function(a){return a.id==b});return c||_.reduce(a.ideas,function(a,c){return a||c.findSubIdeaById(b)},void 0)},a.find=function(b){var c=b(a)?[_.pick(a,"id","title")]:[];return 0===_.size(a.ideas)?c:_.reduce(a.ideas,function(a,c){return _.union(a,c.find(b))},c)},a.getAttr=function(b){return a.attr&&a.attr[b]?_.clone(a.attr[b]):!1},a.sortedSubIdeas=function(){if(!a.ideas)return[];var b=[],c=_.groupBy(_.map(_.keys(a.ideas),parseFloat),function(a){return a>0}),d=_.sortBy(c[!0],Math.abs).concat(_.sortBy(c[!1],Math.abs));return _.each(d,function(c){b.push(a.ideas[c])}),b},a.traverse=function(b){b(a),_.each(a.sortedSubIdeas(),function(a){a.traverse(b)})},a},h=function(a,b){if(b=b||1,0===_.size(a))return 0;var c=_.keys(a);return c.push(0),_.max(_.map(c,parseFloat),function(a){return a*b})},i=function(b){var c,d,e=1;return b.id==a.id&&(d=_.countBy(b.ideas,function(a,b){return 0>b}),(d["true"]||0)<d["false"]&&(e=-1)),c=h(b.ideas,e)+e},j=function(a,b){var c;return a.ideas=a.ideas||{},c=i(a),a.ideas[c]=b,c},k=function(b){return a.id==b?a:a.findSubIdeaById(b)},l=function(a,b){return _(_.map(_.keys(a.ideas),parseFloat)).reject(function(a){return 0>a*b})},m=function(a){return 0>a?-1:1},n={},o={},p=!1,q={},r=function(b,c,d){d?a.dispatchEvent("changed",b,c,d):a.dispatchEvent("changed",b,c)},s=function(b,c,d,e){var f;return"batch"!==b&&!q[e]&&n&&n[e]&&0!==n[e].length?(f=n[e].pop(),n[e].push("batch"===f.eventMethod?{eventMethod:"batch",eventArgs:f.eventArgs.concat([[b].concat(c)]),undoFunction:function(){d(),f.undoFunction()}}:{eventMethod:"batch",eventArgs:[[f.eventMethod].concat(f.eventArgs)].concat([[b].concat(c)]),undoFunction:function(){d(),f.undoFunction()}}),void(p?a.dispatchEvent("changed","redo",void 0,e):(r(b,c,e),o[e]=[]))):void t(b,c,d,e)},t=function(b,c,d,e){var f={eventMethod:b,eventArgs:c,undoFunction:d};return q[e]?void q[e].push(f):(n[e]||(n[e]=[]),n[e].push(f),void(p?a.dispatchEvent("changed","redo",void 0,e):(r(b,c,e),o[e]=[])))},u=function(a,b,c){a.ideas[b]=a.ideas[c],delete a.ideas[c]},v=function(a){if(a.style){a.attr={};var b=a.style.collapsed;delete a.style.collapsed,a.attr.style=a.style,b&&(a.attr.collapsed=b),delete a.style}a.ideas&&_.each(a.ideas,v)},w=function(a){var b=String(a).indexOf(".");return b>0&&a.substr(b+1)},x={};a.getSessionKey=function(){return b},a.nextSiblingId=function(b){var c,d,e,f=a.findParent(b);return f?(c=f.findChildRankById(b),d=l(f,c),e=_.reject(d,function(a){return Math.abs(a)<=Math.abs(c)}),0===e.length?!1:f.ideas[_.min(e,Math.abs)].id):!1},a.sameSideSiblingIds=function(b){var c=a.findParent(b),d=c.findChildRankById(b);return _.without(_.map(_.pick(c.ideas,l(c,d)),function(a){return a.id}),b)},a.getAttrById=function(a,b){var c=k(a);return c&&c.getAttr(b)},a.previousSiblingId=function(b){var c,d,e,f=a.findParent(b);return f?(c=f.findChildRankById(b),d=l(f,c),e=_.reject(d,function(a){return Math.abs(a)>=Math.abs(c)}),0===e.length?!1:f.ideas[_.max(e,Math.abs)].id):!1},a.clone=function(b){var c=b&&b!=a.id&&a.findSubIdeaById(b)||a;return JSON.parse(JSON.stringify(c))},a.cloneMultiple=function(b){return _.map(b,a.clone)},a.calculatePath=function(b,c,d){return a.id==b?[]:(c=c||[a],d=d||a,d.containsDirectChild(b)?c:_.reduce(d.ideas,function(d,e){return d||a.calculatePath(b,[e].concat(c),e)},!1))},a.getSubTreeIds=function(b){var c=[],d=function(a){return _.isEmpty(a.ideas)?[]:void _.each(a.sortedSubIdeas(),function(a){d(a),c.push(a.id)})};return d(a.findSubIdeaById(b)||a),c},a.findParent=function(b,c){return c=c||a,c.containsDirectChild(b)?c:_.reduce(c.ideas,function(c,d){return c||a.findParent(b,d)},!1)},a.startBatch=function(c){var d=c||b;a.endBatch(c),q[d]=[]},a.endBatch=function(a){var c,d,e,f=a||b,g=q[f];q[f]=void 0,_.isEmpty(g)||(1===_.size(g)?t(g[0].eventMethod,g[0].eventArgs,g[0].undoFunction,f):(c=_.map(g,function(a){return[a.eventMethod].concat(a.eventArgs)}),d=_.sortBy(_.map(g,function(a){return a.undoFunction}),function(a,b){return-1*b}),e=function(){_.each(d,function(a){a()})},t("batch",c,e,f)))},a.execCommand=function(c,d,e){return x[c]?x[c].apply(a,[e||b].concat(_.toArray(d))):!1},a.batch=function(b){a.startBatch();try{b()}finally{a.endBatch()}},x.batch=function(b){a.startBatch(b);try{_.each(_.toArray(arguments).slice(1),function(c){a.execCommand(c[0],c.slice(1),b)})}finally{a.endBatch(b)}},a.pasteMultiple=function(b,c){a.startBatch();var d=_.map(c,function(c){return a.paste(b,c)});return a.endBatch(),d},a.paste=function(){return a.execCommand("paste",arguments)},x.paste=function(b,e,f,h){var i,k,l=e==a.id?a:a.findSubIdeaById(e),m=function(a){var b,c,d=_.omit(a,"ideas","id"),e=1;return a.ideas&&(b=_.groupBy(_.map(_.keys(a.ideas),parseFloat),function(a){return a>0}),c=_.sortBy(b[!0],Math.abs).concat(_.sortBy(b[!1],Math.abs)),d.ideas={},_.each(c,function(b){d.ideas[e++]=m(a.ideas[b])})),d};return h&&(c=parseInt(h,10)-1),i=f&&(f.title||f.attr)&&g(m(f),w(h)),l&&i?(k=j(l,i),h&&d(),y(i,"position"),t("paste",[e,f,i.id],function(){delete l.ideas[k]},b),i.id):!1},a.flip=function(){return a.execCommand("flip",arguments)},x.flip=function(b,c){var d,e,f=a.findChildRankById(c);return f?(e=h(a.ideas,-1*m(f)),d=e-10*m(f),u(a,d,f),t("flip",[c],function(){u(a,f,d)},b),!0):!1},a.initialiseTitle=function(){return a.execCommand("initialiseTitle",arguments)},x.initialiseTitle=function(a,b,c){var d,e=k(b);return e?(d=e.title,d==c?!1:(e.title=c,s("initialiseTitle",[b,c],function(){e.title=d},a),!0)):!1},a.updateTitle=function(){return a.execCommand("updateTitle",arguments)},x.updateTitle=function(a,b,c){var d,e=k(b);return e?(d=e.title,d==c?!1:(e.title=c,t("updateTitle",[b,c],function(){e.title=d},a),!0)):!1},a.addSubIdea=function(){return a.execCommand("addSubIdea",arguments)},x.addSubIdea=function(a,b,c,d){var e,f,h=k(b);return h?d&&k(d)?!1:(e=g({title:c,id:d}),f=j(h,e),t("addSubIdea",[b,c,e.id],function(){delete h.ideas[f]},a),e.id):!1},a.removeMultiple=function(b){a.startBatch();var c=_.map(b,a.removeSubIdea);return a.endBatch(),c},a.removeSubIdea=function(){return a.execCommand("removeSubIdea",arguments)},x.removeSubIdea=function(b,c){var d,e,f,g=a.findParent(c);return g?(d=g.findChildRankById(c),e=g.ideas[d],delete g.ideas[d],f=a.links,a.links=_.reject(a.links,function(a){return a.ideaIdFrom==c||a.ideaIdTo==c}),t("removeSubIdea",[c],function(){g.ideas[d]=e,a.links=f},b),!0):!1},a.insertIntermediateMultiple=function(b){a.startBatch();var c=a.insertIntermediate(b[0]);return _.each(b.slice(1),function(b){a.changeParent(b,c)}),a.endBatch(),c},a.insertIntermediate=function(){return a.execCommand("insertIntermediate",arguments)},x.insertIntermediate=function(b,c,d,e){if(a.id==c)return!1;var f,h,i,j=a.findParent(c);return j?e&&k(e)?!1:(f=j.findChildRankById(c))?(h=j.ideas[f],i=g({title:d,id:e}),j.ideas[f]=i,i.ideas={1:h},t("insertIntermediate",[c,d,i.id],function(){j.ideas[f]=h},b),i.id):!1:!1},a.changeParent=function(){return a.execCommand("changeParent",arguments)},x.changeParent=function(b,c,d){var e,f,g,h,i,l=k(d);return c==d?!1:l?(h=a.findSubIdeaById(c))?h.findSubIdeaById(d)?!1:l.containsDirectChild(c)?!1:(e=a.findParent(c))?(f=e.findChildRankById(c),g=j(l,h),i=h.getAttr("position"),y(h,"position"),delete e.ideas[f],t("changeParent",[c,d],function(){y(h,"position",i),e.ideas[f]=h,delete l.ideas[g]},b),!0):!1:!1:!1};var y=function(a,b,c){var d;if(!a)return!1;if(d=_.extend({},a.attr),a.attr=_.extend({},a.attr),!c||"false"===c||_.isObject(c)&&_.isEmpty(c)){if(!a.attr[b])return!1;delete a.attr[b]}else{if(_.isEqual(a.attr[b],c))return!1;a.attr[b]=JSON.parse(JSON.stringify(c))}return 0===_.size(a.attr)&&delete a.attr,function(){a.attr=d}};return a.mergeAttrProperty=function(b,c,d,e){var f=a.getAttrById(b,c)||{};return e?f[d]=e:delete f[d],_.isEmpty(f)&&(f=!1),a.updateAttr(b,c,f)},a.updateAttr=function(){return a.execCommand("updateAttr",arguments)},x.updateAttr=function(a,b,c,d){var e,f=k(b);return e=y(f,c,d),e&&t("updateAttr",[b,c,d],e,a),!!e},a.moveRelative=function(b,c){var d=a.findParent(b),e=d&&d.findChildRankById(b),f=e&&_.sortBy(l(d,e),Math.abs),g=f&&f.indexOf(e),h=g+(c>0?c+1:c),i=h>=0&&d&&f&&d.ideas[f[h]];return 0>h||!d?!1:a.positionBefore(b,i&&i.id,d)},a.positionBefore=function(){return a.execCommand("positionBefore",arguments)},x.positionBefore=function(b,c,d,e){e=e||a;var f,g,i,j,k,m,n;if(n=e.findChildRankById(c),!n)return _.reduce(e.ideas,function(a,e){return a||x.positionBefore(b,c,d,e)},!1);if(c==d)return!1;if(f=0,d){if(g=e.findChildRankById(d),!g)return!1;if(i=l(e,n),j=_.reject(_.sortBy(i,Math.abs),function(a){return Math.abs(a)>=Math.abs(g)}),k=j.length>0?_.max(j,Math.abs):0,k==n)return!1;f=k+(g-k)/2}else{if(m=h(e.ideas,0>n?-1:1),m==n)return!1;f=m+10*(0>n?-1:1)}return f==n?!1:(u(e,f,n),t("positionBefore",[c,d],function(){u(e,n,f)},b),!0)},observable(a),function(){var b=function(a,b){var c,d,e;return a===b?!1:(d=k(a))?(e=k(b))?(c=_.find(d.ideas,function(a){return a.id===b})||_.find(e.ideas,function(b){return b.id===a}),c?!1:!0):!1:!1};a.addLink=function(){return a.execCommand("addLink",arguments)},x.addLink=function(c,d,e){var f,g;return b(d,e)?(f=_.find(a.links,function(a){return a.ideaIdFrom===d&&a.ideaIdTo===e||a.ideaIdFrom===e&&a.ideaIdTo===d}))?!1:(a.links=a.links||[],g={ideaIdFrom:d,ideaIdTo:e,attr:{style:{color:"#FF0000",lineStyle:"dashed"}}},a.links.push(g),t("addLink",[d,e],function(){a.links.pop()},c),!0):!1},a.removeLink=function(){return a.execCommand("removeLink",arguments)},x.removeLink=function(b,c,d){for(var e,f=0;a.links&&f<a.links.length;){if(e=a.links[f],String(e.ideaIdFrom)===String(c)&&String(e.ideaIdTo)===String(d))return a.links.splice(f,1),t("removeLink",[c,d],function(){a.links.push(_.clone(e))},b),!0;f+=1}return!1},a.getLinkAttr=function(b,c,d){var e=_.find(a.links,function(a){return a.ideaIdFrom==b&&a.ideaIdTo==c});return e&&e.attr&&e.attr[d]?e.attr[d]:!1},a.updateLinkAttr=function(){return a.execCommand("updateLinkAttr",arguments)},x.updateLinkAttr=function(b,c,d,e,f){var g,h=_.find(a.links,function(a){return a.ideaIdFrom==c&&a.ideaIdTo==d});return g=y(h,e,f),g&&t("updateLinkAttr",[c,d,e,f],g,b),!!g}}(),a.undo=function(){return a.execCommand("undo",arguments)},x.undo=function(b){a.endBatch();var c;return c=n[b]&&n[b].pop(),c&&c.undoFunction?(c.undoFunction(),o[b]||(o[b]=[]),o[b].push(c),a.dispatchEvent("changed","undo",[],b),!0):!1},a.redo=function(){return a.execCommand("redo",arguments)},x.redo=function(b){a.endBatch();var c;return c=o[b]&&o[b].pop(),c?(p=!0,a.execCommand(c.eventMethod,c.eventArgs,b),p=!1,!0):!1},2!=a.formatVersion&&(v(a),a.formatVersion=2),g(a),a},MAPJS.defaultStyles={root:{background:"#22AAE0"},nonRoot:{background:"#E0E0E0"}},MAPJS.layoutLinks=function(a,b){"use strict";var c={};return _.each(a.links,function(a){b[a.ideaIdFrom]&&b[a.ideaIdTo]&&(c[a.ideaIdFrom+"_"+a.ideaIdTo]={ideaIdFrom:a.ideaIdFrom,ideaIdTo:a.ideaIdTo,attr:_.clone(a.attr)})}),c},MAPJS.calculateFrame=function(a,b){"use strict";b=b||0;var c={top:_.min(a,function(a){return a.y}).y-b,left:_.min(a,function(a){return a.x}).x-b};return c.width=b+_.max(_.map(a,function(a){return a.x+a.width}))-c.left,c.height=b+_.max(_.map(a,function(a){return a.y+a.height}))-c.top,c},MAPJS.contrastForeground=function(a){"use strict";var b=Color(a).luminosity();return.5>b?"#EEEEEE":.9>b?"#4F4F4F":"#000000"},MAPJS.Outline=function(a,b){"use strict";var c=function(a,b){return _.map(a,function(a){return{l:a.l,h:a.h+b}})};this.initialHeight=function(){return this.bottom[0].h-this.top[0].h},this.borders=function(){return _.pick(this,"top","bottom")},this.spacingAbove=function(a){for(var b=0,c=0,d=0,e=0,f=0;b<this.bottom.length&&c<a.top.length;)d=Math.max(d,this.bottom[b].h-a.top[c].h),e+this.bottom[b].l<f+a.top[c].l?(e+=this.bottom[b].l,b+=1):e+this.bottom[b].l===f+a.top[c].l?(e+=this.bottom[b].l,b+=1,f+=a.top[c].l,c+=1):(f+=a.top[c].l,c+=1);return d},this.indent=function(a,b){if(!a)return this;var c=this.top.slice(),d=this.bottom.slice(),e=(d[0].h+c[0].h)/2;return c.unshift({h:e-b/2,l:a}),d.unshift({h:e+b/2,l:a}),new MAPJS.Outline(c,d)},this.stackBelow=function(a,b){var d=a.spacingAbove(this),e=MAPJS.Outline.extendBorder(a.top,c(this.top,d+b)),f=MAPJS.Outline.extendBorder(c(this.bottom,d+b),a.bottom);return new MAPJS.Outline(e,f)},this.expand=function(a,b){var d=a-this.top[0].h,e=b-this.bottom[0].h,f=c(this.top,d),g=c(this.bottom,e);return new MAPJS.Outline(f,g)},this.insertAtStart=function(a,b){var d=(this.initialHeight(),0),e=c(this.top,d),f=c(this.bottom,d),g=function(a){a[0].l*=.5,a[1].l+=a[0].l};return e[0].l+=b,f[0].l+=b,e.unshift({h:-.5*a.height,l:a.width}),f.unshift({h:.5*a.height,l:a.width}),e[0].h>e[1].h&&g(e),f[0].h<f[1].h&&g(f),new MAPJS.Outline(e,f)},this.top=a.slice(),this.bottom=b.slice()},MAPJS.Outline.borderLength=function(a){"use strict";return _.reduce(a,function(a,b){return a+b.l},0)},MAPJS.Outline.borderSegmentIndexAt=function(a,b){"use strict";for(var c=0,d=-1;b>=c;){if(d+=1,d>=a.length)return-1;c+=a[d].l}return d},MAPJS.Outline.extendBorder=function(a,b){"use strict";var c,d=a.slice(),e=MAPJS.Outline.borderLength(a),f=MAPJS.Outline.borderSegmentIndexAt(b,e);return f>=0&&(c=MAPJS.Outline.borderLength(b.slice(0,f+1)),d.push({h:b[f].h,l:c-e}),d=d.concat(b.slice(f+1))),d},MAPJS.Tree=function(a){"use strict";_.extend(this,a),this.toLayout=function(a,b,c,d){b=b||0,c=c||0;var e,f={nodes:{},connectors:{}};return e=_.pick(this,"id","title","attr","width","height"),e.level=a||1,1===e.level?(e.x=-.5*this.width,e.y=-.5*this.height):(e.x=b+this.deltaX||0,e.y=c+this.deltaY||0),f.nodes[this.id]=e,void 0!==d&&(f.connectors[e.id]={from:d,to:e.id}),this.subtrees&&this.subtrees.forEach(function(a){var b=a.toLayout(e.level+1,e.x,e.y,e.id);_.extend(f.nodes,b.nodes),_.extend(f.connectors,b.connectors)}),f}},MAPJS.Outline.fromDimensions=function(a){"use strict";return new MAPJS.Outline([{h:-.5*a.height,l:a.width}],[{h:.5*a.height,l:a.width}])},MAPJS.calculateTree=function(a,b,c,d){"use strict";var e={id:a.id,title:a.title,attr:a.attr,deltaY:0,deltaX:0},f=function(a,b){var c,d,e,f,g,h,i=_.map(a,function(a){return _.pick(a,"deltaX","deltaY")});for(c=0;c<a.length;c+=1)d=a[c],d.attr&&d.attr.position?(d.deltaY=d.attr.position[1],(void 0===g||d.attr.position[2]>a[g].attr.position[2])&&(g=c)):d.deltaY+=b,c>0&&(e=i[c].deltaY-i[c-1].deltaY,f=a[c].deltaY-a[c-1].deltaY,e>f&&(d.deltaY+=e-f));if(h=g&&a[g].attr.position[1]-a[g].deltaY)for(c=0;c<a.length;c+=1)a[c].deltaY+=h},g=function(){return!(_.isEmpty(a.ideas)||a.attr&&a.attr.collapsed)},h=function(){var b=_.map(_.keys(a.ideas),parseFloat),c=d?_.filter(b,function(b){return d(b,a.id)}):b;return _.sortBy(c,Math.abs)},i=function(){var b=[];return _.each(h(),function(c){b.push(a.ideas[c])}),b},j=b(a),k=function(a){var b,d,g,h,i;_.each(a,function(a){a.deltaX=j.width+c,g=a.attr&&a.attr.position&&a.attr.position[0],g&&g>a.deltaX?(h=g-a.deltaX,a.deltaX=g):h=0,b?(i=a.outline.indent(h,c),d=i.initialHeight(),b=i.stackBelow(b,c),a.deltaY=b.initialHeight()-d/2-a.height/2):b=a.outline.indent(h,c)}),a&&a.length&&(f(a,.5*(j.height-b.initialHeight())),b=b.expand(a[0].deltaY-.5*j.height,a[a.length-1].deltaY+a[a.length-1].height-.5*j.height)),e.outline=b.insertAtStart(j,c)};return _.extend(e,j),e.outline=new MAPJS.Outline.fromDimensions(j),g()&&(e.subtrees=_.map(i(),function(a){return MAPJS.calculateTree(a,b,c,d)}),_.isEmpty(e.subtrees)||k(e.subtrees)),new MAPJS.Tree(e)},MAPJS.calculateLayout=function(a,b,c){"use strict";var d,e,f,g,h=function(a){_.each(a,function(a){a.attr=a.attr||{},a.attr.style=_.extend({},MAPJS.defaultStyles[1===a.level?"root":"nonRoot"],a.attr.style)})},i=function(b,c){return c!==a.id||b>0},j=function(b,c){return c!==a.id||0>b};return c=c||20,d=MAPJS.calculateTree(a,b,c,i),e=MAPJS.calculateTree(a,b,c,j),f=d.toLayout(),g=e.toLayout(),_.each(g.nodes,function(a){a.x=-1*a.x-a.width}),_.extend(g.nodes,f.nodes),_.extend(g.connectors,f.connectors),h(g.nodes),g.links=MAPJS.layoutLinks(a,g.nodes),g},MAPJS.MapModel=function(a,b,c){"use strict";b=b||["double click to edit"],c=c||b;var d,e,f,g,h,i,j=this,k={nodes:{},connectors:{}},l=!0,m=!0,n=[],o=function(a){var b=_.clone(n);n=a,j.dispatchEvent("activatedNodesChanged",_.difference(n,b),_.difference(b,n))},p=function(a){return a[Math.floor(a.length*Math.random())]},q=300,r=function(a,b,c){(b||c)&&_.each(a,function(a){a.x+=b,a.y+=c,j.dispatchEvent("nodeMoved",a)})},s=function(a){var b,c,d,g,h,i,l,m;for(b in k.connectors)g=a.connectors[b],h=k.connectors[b],g&&g.from===h.from&&g.to===h.to||j.dispatchEvent("connectorRemoved",h);for(b in k.nodes)d=k.nodes[b],c=a.nodes[b],c||(b==f&&j.selectNode(e.id),j.dispatchEvent("nodeRemoved",d,b));for(b in a.nodes)d=k.nodes[b],c=a.nodes[b],d?((c.x!==d.x||c.y!==d.y)&&j.dispatchEvent("nodeMoved",c),c.title!==d.title&&j.dispatchEvent("nodeTitleChanged",c),_.isEqual(c.attr||{},d.attr||{})||j.dispatchEvent("nodeAttrChanged",c)):j.dispatchEvent("nodeCreated",c);for(b in a.connectors)g=a.connectors[b],h=k.connectors[b],h&&g.from===h.from&&g.to===h.to||j.dispatchEvent("connectorCreated",g);for(i in a.links)l=a.links[i],m=k.links&&k.links[i],m?_.isEqual(l.attr||{},m&&m.attr||{})||j.dispatchEvent("linkAttrChanged",l):j.dispatchEvent("linkCreated",l);for(i in k.links)m=k.links[i],l=a.links&&a.links[i],l||j.dispatchEvent("linkRemoved",m);k=a,j.dispatchEvent("layoutChangeComplete")},t=function(a){h=f,i=n.slice(0),j.selectNode(a),j.editNode(!1,!0,!0)},u=function(){return f||e.id},v=function(){h=!1,i=!1,s(j.reactivate(a(e)))},w=function(){return e.findSubIdeaById(f)||e},x=function(a,b){var c=e.findSubIdeaById(b)||e;c.getAttr("collapsed")&&e.updateAttr(b,"collapsed",!1)};observable(this),d=j.dispatchEvent.bind(j,"analytic","mapModel"),j.getIdea=function(){return e},j.isEditingEnabled=function(){return m},j.getCurrentLayout=function(){return k},j.analytic=d,j.getCurrentlySelectedIdeaId=u,this.setIdea=function(a){e&&(e.removeEventListener("changed",v),j.dispatchEvent("nodeSelectionChanged",f,!1),f=void 0),e=a,e.addEventListener("changed",v),v(),j.selectNode(e.id,!0),j.dispatchEvent("mapViewResetRequested")},this.setEditingEnabled=function(a){m=a},this.getEditingEnabled=function(){return m},this.setInputEnabled=function(a){l!==a&&(l=a,j.dispatchEvent("inputEnabledChanged",a))},this.getInputEnabled=function(){return l},this.selectNode=function(a,b){(b||l&&(a!==f||!j.isActivated(a)))&&(f&&j.dispatchEvent("nodeSelectionChanged",f,!1),f=a,j.dispatchEvent("nodeSelectionChanged",a,!0))},this.clickNode=function(a,b){var c=b&&b.button;b&&(b.altKey||b.ctrlKey||b.metaKey)?j.addLink("mouse",a):b&&b.shiftKey?j.toggleActivationOnNode("mouse",a):g&&!c?(this.addLink("mouse",a),this.toggleAddLinkMode()):(this.selectNode(a),c&&l&&j.dispatchEvent("contextMenuRequested",a,b.layerX,b.layerY))},this.findIdeaById=function(a){return e.id==a?e:e.findSubIdeaById(a)},this.getSelectedStyle=function(a){return this.getStyleForId(f,a)},this.getStyleForId=function(a,b){var c=k.nodes&&k.nodes[a];return c&&c.attr&&c.attr.style&&c.attr.style[b]},this.toggleCollapse=function(a){var b,c=w();b=j.isActivated(c.id)&&_.size(c.ideas)>0?c.getAttr("collapsed"):j.everyActivatedIs(function(a){var b=j.findIdeaById(a);return b&&_.size(b.ideas)>0?b.getAttr("collapsed"):!0}),this.collapse(a,!b)},this.collapse=function(a,b){d("collapse:"+b,a);var c,f,g=u(),h=function(){return g&&k&&k.nodes&&k.nodes[g]};c=h(),l&&j.applyToActivated(function(a){var c=j.findIdeaById(a);c&&(!b||c.ideas&&_.size(c.ideas)>0)&&e.updateAttr(a,"collapsed",b)}),f=h(),c&&f&&r(k.nodes,c.x-f.x,c.y-f.y),j.dispatchEvent("layoutChangeComplete")},this.updateStyle=function(a,b,c){return m?void(l&&(d("updateStyle:"+b,a),j.applyToActivated(function(a){j.getStyleForId(a,b)!=c&&e.mergeAttrProperty(a,"style",b,c)}))):!1},this.updateLinkStyle=function(a,b,c,f,g){if(!m)return!1;if(l){d("updateLinkStyle:"+f,a);var h=_.extend({},e.getLinkAttr(b,c,"style"));h[f]=g,e.updateLinkAttr(b,c,"style",h)}},this.addSubIdea=function(a,c){if(!m)return!1;var g,h=c||f;d("addSubIdea",a),l&&(e.batch(function(){x(a,h),g=e.addSubIdea(h,p(b))}),g&&t(g))},this.insertIntermediate=function(a){if(!m)return!1;if(!l||f===e.id)return!1;var b,c=[];d("insertIntermediate",a),j.applyToActivated(function(a){c.push(a)}),b=e.insertIntermediateMultiple(c),b&&t(b)},this.addSiblingIdea=function(a){var c,g;return m?(d("addSiblingIdea",a),void(l&&(g=e.findParent(f)||e,e.batch(function(){x(a,g.id),c=e.addSubIdea(g.id,p(b))}),c&&t(c)))):!1},this.removeSubIdea=function(a){if(!m)return!1;if(d("removeSubIdea",a),l){var b,c=u(),f=e.findParent(c);j.applyToActivated(function(a){var d=e.removeSubIdea(a);c==a&&(b=d)}),b&&j.selectNode(f.id)}},this.updateTitle=function(a,b,c){c?e.initialiseTitle(a,b):e.updateTitle(a,b)},this.editNode=function(a,e,g){if(!m)return!1;if(a&&d("editNode",a),!l)return!1;var h=w().title;("Press Space or double-click to edit"===h||-1!==c.indexOf(h)||-1!==b.indexOf(h))&&(e=!0),j.dispatchEvent("nodeEditRequested",f,e,!!g)},this.editIcon=function(a){return m?(a&&d("editIcon",a),l?void j.dispatchEvent("nodeIconEditRequested",f):!1):!1},this.scaleUp=function(a){j.scale(a,1.25)},this.scaleDown=function(a){j.scale(a,.8)},this.scale=function(a,b,c){l&&(j.dispatchEvent("mapScaleChanged",b,c),d(1>b?"scaleDown":"scaleUp",a))},this.move=function(a,b,c){l&&(j.dispatchEvent("mapMoveRequested",b,c),d("move",a))},this.resetView=function(a){l&&(j.selectNode(e.id),j.dispatchEvent("mapViewResetRequested"),d("resetView",a))},this.openAttachment=function(a,b){d("openAttachment",a),b=b||f;var c=k.nodes[b],e=c&&c.attr&&c.attr.attachment;c&&j.dispatchEvent("attachmentOpened",b,e)},this.setAttachment=function(a,b,c){if(!m)return!1;d("setAttachment",a);var f=!(!c||!c.content);e.updateAttr(b,"attachment",f&&c)},this.addLink=function(a,b){return m?(d("addLink",a),void e.addLink(f,b)):!1},this.selectLink=function(a,b,c){return m?(d("selectLink",a),b?void j.dispatchEvent("linkSelected",b,c,e.getLinkAttr(b.ideaIdFrom,b.ideaIdTo,"style")):!1):!1},this.removeLink=function(a,b,c){return m?(d("removeLink",a),void e.removeLink(b,c)):!1},this.toggleAddLinkMode=function(a){return m?l?(d("toggleAddLinkMode",a),g=!g,void j.dispatchEvent("addLinkModeToggled",g)):!1:!1},this.cancelCurrentAction=function(a){return l?m?void(g&&this.toggleAddLinkMode(a)):!1:!1},j.undo=function(a){if(!m)return!1;d("undo",a);var b=h,c=i;l&&(e.undo(),b&&j.selectNode(b),c&&o(c))},j.redo=function(a){return m?(d("redo",a),void(l&&e.redo())):!1},j.moveRelative=function(a,b){return m?(d("moveRelative",a),void(l&&e.moveRelative(f,b))):!1},j.cut=function(a){if(!m)return!1;if(d("cut",a),l){var b,c=[],f=[];j.applyToActivated(function(a){c.push(a),f.push(e.findParent(a).id)}),j.clipBoard=e.cloneMultiple(c),e.removeMultiple(c),b=_.find(f,e.findSubIdeaById),j.selectNode(b||e.id)}},j.copy=function(a){var b=[];return m?(d("copy",a),void(l&&(j.applyToActivated(function(a){b.push(a)}),j.clipBoard=e.cloneMultiple(b)))):!1},j.paste=function(a){if(!m)return!1;if(d("paste",a),l){var b=e.pasteMultiple(f,j.clipBoard);b&&b[0]&&j.selectNode(b[0])}},j.pasteStyle=function(a){if(!m)return!1;if(d("pasteStyle",a),l&&j.clipBoard&&j.clipBoard[0]){var b=j.clipBoard[0].attr&&j.clipBoard[0].attr.style;j.applyToActivated(function(a){e.updateAttr(a,"style",b)})}},j.getIcon=function(a){var b=k.nodes[a||f];return b?b.attr&&b.attr.icon:!1},j.setIcon=function(a,b,c,g,h,i){if(!m)return!1;d("setIcon",a),i=i||f;var k=j.findIdeaById(i);return k?void(b?e.updateAttr(i,"icon",{url:b,width:c,height:g,position:h}):k.title||i===e.id?e.updateAttr(i,"icon",!1):e.removeSubIdea(i)):!1},j.moveUp=function(a){j.moveRelative(a,-1)},j.moveDown=function(a){j.moveRelative(a,1)},j.getSelectedNodeId=function(){return u()},function(){var a=function(a){return k.nodes[a].x>=k.nodes[e.id].x},b=function(a){return k.nodes[a].x<=k.nodes[e.id].x},c=function(){return _.map(k.nodes,function(a,b){return _.extend({id:parseInt(b,10)},a)})},g=function(a,c,g){var h,i,k=f===e.id,m=k?-1/0:1/0;if(l)if(d(c,a),b(f)){h=e.id===f?e:e.findSubIdeaById(f),x(a,h.id);for(i in h.ideas)i=parseFloat(i),(k&&0>i&&i>m||!k&&i>0&&m>i)&&(m=i);1/0!==m&&m!==-1/0&&g.apply(j,[h.ideas[m].id])}else g.apply(j,[e.findParent(f).id])},h=function(b,c,g){var h,i,k=1/0;if(l)if(d(c,b),a(f)){h=e.id===f?e:e.findSubIdeaById(f),x(b,h.id);for(i in h.ideas)i=parseFloat(i),i>0&&k>i&&(k=i);1/0!==k&&g.apply(j,[h.ideas[k].id])}else g.apply(j,[e.findParent(f).id])},i=function(a,b,g){var h,i,m=e.previousSiblingId(f),n=k.nodes[f];if(l)if(d(b,a),m)g.apply(j,[m]);else{if(!n)return;if(h=_.reject(c(),function(a){return a.y>=n.y||Math.abs(a.x-n.x)>q}),0===_.size(h))return;i=_.min(h,function(a){return Math.pow(a.x-n.x,2)+Math.pow(a.y-n.y,2)}),g.apply(j,[i.id])}},m=function(a,b,g){var h,i,m=e.nextSiblingId(f),n=k.nodes[f];if(l)if(d(b,a),m)g.apply(j,[m]);else{if(!n)return;if(h=_.reject(c(),function(a){return a.y<=n.y||Math.abs(a.x-n.x)>q}),0===_.size(h))return;i=_.min(h,function(a){return Math.pow(a.x-n.x,2)+Math.pow(a.y-n.y,2)}),g.apply(j,[i.id])}},p={Left:g,Up:i,Down:m,Right:h};j.getActivatedNodeIds=function(){return n.slice(0)},j.activateSiblingNodes=function(a){var b,c=e.findParent(f);d("activateSiblingNodes",a),c&&c.ideas&&(b=_.map(c.ideas,function(a){return a.id}),o(b))},j.activateNodeAndChildren=function(a){d("activateNodeAndChildren",a);var b=u(),c=e.getSubTreeIds(b);c.push(b),o(c)},_.each(["Left","Right","Up","Down"],function(a){j["activateNode"+a]=function(b){p[a](b,"activateNode"+a,function(a){j.activateNode(b,a),f=a})},j["selectNode"+a]=function(b){p[a](b,"selectNode"+a,j.selectNode)}}),j.toggleActivationOnNode=function(a,b){d("toggleActivated",a),o(j.isActivated(b)?_.without(n,b):[b].concat(n))},j.activateNode=function(a,b){d("activateNode",a),j.isActivated(b)||(n.push(b),j.dispatchEvent("activatedNodesChanged",[b],[]))},j.activateChildren=function(a){d("activateChildren",a);var b=w();!b||_.isEmpty(b.ideas)||b.getAttr("collapsed")||o(e.getSubTreeIds(b.id))},j.activateSelectedNode=function(a){d("activateSelectedNode",a),o([u()])},j.isActivated=function(a){return _.find(n,function(b){return a==b})},j.applyToActivated=function(a){e.batch(function(){_.each(n,a)})},j.everyActivatedIs=function(a){return _.every(n,a)},j.activateLevel=function(a,b){d("activateLevel",a);var c=_.map(_.filter(k.nodes,function(a){return a.level==b}),function(a){return a.id});_.isEmpty(c)||o(c)},j.reactivate=function(a){return _.each(a.nodes,function(a){_.contains(n,a.id)&&(a.activated=!0)}),a},j.addEventListener("nodeSelectionChanged",function(a,b){return b?void o([a]):void o([])},1),j.addEventListener("nodeRemoved",function(a,b){var c=u();j.isActivated(b)&&!j.isActivated(c)&&o(n.concat([c]))})}()},MAPJS.dragdrop=function(a,b,c){"use strict";var d,e=function(a){return b.get("#node_"+a)[0]},f=function(a,b){var c=e(a);c.setIsDroppable(b)},g=function(a){d!==a&&(d&&f(d,!1),d=a,d&&f(d,!0))},h=function(a,b,c){return a>=c.x&&b>=c.y&&a<=c.x+c.width&&b<=c.y+c.height},i=function(a,b,c,d){return a!=d.id&&h(b,c,d)},j=function(b,c,d){var e=b.x<c.x&&d<b.x,f=b.x>c.x&&b.x<d;return e||f?a.getIdea().flip(c.id):!1},k=function(b,c,d){var e,f;if(a.isEditingEnabled()){for(e in a.getCurrentLayout().nodes)if(f=a.getCurrentLayout().nodes[e],i(b,c,d,f))return void g(e);g(void 0)}},l=function(){return a.getCurrentLayout().nodes[a.getIdea().id]},m=function(b,c,d,e,f,h,k){var m,n,o,p=a.getCurrentLayout().nodes[b],q=l(),r={id:null,y:1/0},s=a.getIdea(),t=s.findParent(b),u=a.getCurrentLayout().nodes[t.id],v=1,w=function(){return 2===p.level||(p.x-u.x)*(c-u.x)>0};if(!a.isEditingEnabled())return void a.dispatchEvent("nodeMoved",p,"failed");g(void 0),a.dispatchEvent("nodeMoved",p);for(m in a.getCurrentLayout().nodes)if(n=a.getCurrentLayout().nodes[m],i(b,c,d,n))return void(h?(o=a.getIdea().clone(b),o&&a.getIdea().paste(m,o)||(a.dispatchEvent("nodeMoved",p,"failed"),a.analytic("nodeDragCloneFailed"))):a.getIdea().changeParent(b,m)||(a.dispatchEvent("nodeMoved",p,"failed"),a.analytic("nodeDragParentFailed"),s.updateAttr(b,"position")));s.startBatch(),2===p.level&&j(q,p,c),_.each(s.sameSideSiblingIds(b),function(b){n=a.getCurrentLayout().nodes[b],d<n.y&&n.y<r.y&&(r=n)}),s.positionBefore(b,r.id),k&&w()&&(a.analytic("nodeManuallyPositioned"),a.selectNode(b),v=_.max(_.map(t.ideas,function(a){return a.id!==b&&a.attr&&a.attr.position&&a.attr.position[2]||0})),s.updateAttr(b,"position",[Math.abs(e-u.x),f-u.y,v+1])),s.endBatch()},n=function(a,c){return{x:(a-b.getX())/(b.getScale().x||1),y:(c-b.getY())/(b.getScale().y||1)}},o=function(a){return a.changedTouches&&a.changedTouches[0]?n(a.changedTouches[0].clientX,a.changedTouches[0].clientY):n(a.layerX,a.layerY)},p=function(b,c,d,e){var f,g,i=a.getIdea(),j=o(e),k=function(e,f){var g=Math.min(c,300)/c,h=Math.min(d,300)/d,i=Math.min(g,h);a.setIcon("drag and drop",b,Math.round(c*i),Math.round(d*i),f,e)},l=function(){i.startBatch(),k(i.addSubIdea(a.getSelectedNodeId()),"center"),i.endBatch()};for(g in a.getCurrentLayout().nodes)if(f=a.getCurrentLayout().nodes[g],h(j.x,j.y,f))return k(g,"left");l()};jQuery(b.getContainer()).imageDropWidget(c),c.addEventListener("imageInserted",p),a.addEventListener("nodeCreated",function(a){var b,c=e(a.id);c.on("dragstart",function(a){b=a.shiftKey,c.moveToTop(),c.setShadowOffset(8),c.setOpacity(.3)}),c.on("dragmove",function(b){var c=o(b);k(a.id,c.x,c.y)}),c.on("dragend",function(d){var e=o(d);c.setShadowOffset(4),c.setOpacity(1),m(a.id,e.x,e.y,c.getX(),c.getY(),d.shiftKey,b)})})},function(){"use strict";var a,b,c;Kinetic.Connector=function(a){this.shapeFrom=a.shapeFrom,this.shapeTo=a.shapeTo,this.shapeType="Connector",Kinetic.Shape.call(this,a),this._setDrawFuncs()},a=function(a,b,c,d,e,f,g,h){var i=e>a?.1:.9,j=1-i;return{from:{x:a+j*c,y:b+.5*d},to:{x:e+i*g,y:f+.5*h},controlPointOffset:0}},b=function(a,b){return c(a.getX(),a.getY(),a.getWidth(),a.getHeight(),b.getX(),b.getY(),b.getWidth(),b.getHeight())},c=_.memoize(function(b,c,d,e,f,g,h,i){var j,k=10,l=g+.5*i,m=c+.5*e;return Math.abs(m-l)+k<Math.max(i,.75*e)?a(b,c,d,e,f,g,h,i):(j=f>b?0:1,{from:{x:b+.5*d,y:c+.5*e},to:{x:f+j*h,y:g+.5*i},controlPointOffset:.75})},function(){return Array.prototype.join.call(arguments,",")}),Kinetic.Connector.prototype={isVisible:function(a){var c=this.getStage(),d=b(this.shapeFrom,this.shapeTo),e=Math.min(d.from.x,d.to.x),f=Math.min(d.from.y,d.to.y),g=new MAPJS.Rectangle(e,f,Math.max(d.from.x,d.to.x)-e,Math.max(d.from.y,d.to.y)-f);return c&&c.isRectVisible(g,a)},drawFunc:function(a){var c,d,e,f=a.getContext(),g=this.shapeFrom,h=this.shapeTo;this.isVisible()&&(c=b(g,h),c&&(f.beginPath(),f.moveTo(c.from.x,c.from.y),d=c.controlPointOffset*(c.from.y-c.to.y),e=1.5*Math.min(h.getHeight(),g.getHeight()),d=Math.max(-e,Math.min(e,d)),f.quadraticCurveTo(c.from.x,c.to.y-d,c.to.x,c.to.y),a.stroke(this)))
}},Kinetic.Util.extend(Kinetic.Connector,Kinetic.Shape)}(),function(){"use strict";Kinetic.Link=function(a){this.shapeFrom=a.shapeFrom,this.shapeTo=a.shapeTo,this.shapeType="Link",Kinetic.Shape.call(this,a),this._setDrawFuncs()};var a=_.memoize(function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p=[{x:a+.5*c,y:b},{x:a+c,y:b+.5*d},{x:a+.5*c,y:b+d},{x:a,y:b+.5*d}],q=[{x:e+.5*g,y:f},{x:e+g,y:f+.5*h},{x:e+.5*g,y:f+h},{x:e,y:f+.5*h}],r=1/0;for(i=0;i<p.length;i+=1)for(j=0;j<q.length;j+=1)m=p[i].x-q[j].x,n=p[i].y-q[j].y,o=m*m+n*n,r>o&&(k=i,l=j,r=o);return{from:p[k],to:q[l]}},function(){return Array.prototype.join.call(arguments,",")}),b=function(b,c){return a(b.getX(),b.getY(),b.getWidth(),b.getHeight(),c.getX(),c.getY(),c.getWidth(),c.getHeight())};Kinetic.Link.prototype={drawHitFunc:function(a){var c,d=a.getContext(),e=this.shapeFrom,f=this.shapeTo,g=this.getStrokeWidth();this.setStrokeWidth(9*g),c=b(e,f),d.fillStyle=this.getStroke(),d.beginPath(),d.moveTo(c.from.x,c.from.y),d.lineTo(c.to.x,c.to.y),a.stroke(this),this.setStrokeWidth(g)},drawFunc:function(a){var c,d=a.getContext(),e=this.shapeFrom,f=this.shapeTo,g=Math.tan(Math.PI/9);if(c=b(e,f),d.fillStyle=this.getStroke(),d.beginPath(),d.moveTo(c.from.x,c.from.y),d.lineTo(c.to.x,c.to.y),a.stroke(this),this.attrs.arrow){var h,i,j,k,l,m,n=14,o=c.to.x-c.from.x,p=c.to.y-c.from.y;0===o?(l=0>p?-1:1,h=c.to.x+n*Math.sin(g)*l,j=c.to.x-n*Math.sin(g)*l,i=c.to.y-n*Math.cos(g)*l,k=c.to.y-n*Math.cos(g)*l):(m=p/o,c.from.x<c.to.x&&(n=-n),h=c.to.x+(1-m*g)*n/Math.sqrt((1+m*m)*(1+g*g)),i=c.to.y+(m+g)*n/Math.sqrt((1+m*m)*(1+g*g)),j=c.to.x+(1+m*g)*n/Math.sqrt((1+m*m)*(1+g*g)),k=c.to.y+(m-g)*n/Math.sqrt((1+m*m)*(1+g*g))),d.moveTo(h,i),d.lineTo(c.to.x,c.to.y),d.lineTo(j,k),d.lineTo(h,i),d.fill()}}},Kinetic.Util.extend(Kinetic.Link,Kinetic.Shape)}(),Kinetic.Link.prototype.setMMAttr=function(a){"use strict";var b=a&&a.style,c={solid:[],dashed:[8,8]};this.setStroke(b&&b.color||"red"),this.setDashArray(c[b&&b.lineStyle||"dashed"]),this.attrs.arrow=b&&b.arrow||!1},Kinetic.Clip=function(a){"use strict";this.createAttrs(),Kinetic.Shape.call(this,a),this.shapeType="Clip",this._setDrawFuncs()},Kinetic.Clip.prototype.drawFunc=function(a){"use strict";var b=a.getContext(),c=2*this.getWidth()-2*this.getRadius();b.beginPath(),b.moveTo(0,this.getClipTo()),b.arcTo(0,0,2*this.getWidth(),0,this.getWidth()),b.arcTo(2*this.getWidth(),0,2*this.getWidth(),this.getHeight(),this.getWidth()),b.arcTo(2*this.getWidth(),this.getHeight(),0,this.getHeight(),this.getRadius()),b.arcTo(c,this.getHeight(),c,0,this.getRadius()),b.lineTo(c,.5*this.getClipTo()),a.fillStroke(this)},Kinetic.Node.addGetterSetter(Kinetic.Clip,"clipTo",0),Kinetic.Node.addGetterSetter(Kinetic.Clip,"radius",0),Kinetic.Util.extend(Kinetic.Clip,Kinetic.Shape),function(){"use strict";function a(a,b,c,d){if(c=c||"\n",b=b||75,d=d||!1,!a)return a;var e=".{1,"+b+"}(\\s|$)"+(d?"|.{"+b+"}|.+$":"|\\S+?(\\s|$)");return a.match(new RegExp(e,"g")).join(c)}function b(b){var c=b.split("\n"),d=_.map(c,function(b){return a(b,f,"\n",!1)});return d.join("\n")}function c(){var a=new Kinetic.Group,b={width:10,height:20,rotation:.6,stroke:"#555555",strokeWidth:3,cornerRadius:6,shadowOffset:[2,2],shadow:"#CCCCCC",shadowBlur:.4,shadowOpacity:.4},c=new Kinetic.Rect(b),d=new Kinetic.Rect(b);return d.setX(7),d.setY(-7),a.add(c),a.add(d),a.setActive=function(b){d.setStroke(b?"black":"#555555"),c.setStroke(d.getStroke()),a.getLayer().draw()},a}function d(){var a,b,c={width:5,height:25,radius:3,rotation:.1,strokeWidth:2,clipTo:10};return a=new Kinetic.Group,a.getClipMargin=function(){return c.clipTo},a.add(new Kinetic.Clip(_.extend({stroke:"darkslategrey",x:1,y:1},c))),b=new Kinetic.Clip(_.extend({stroke:"skyblue",x:0,y:0},c)),a.add(b),a.on("mouseover",function(){b.setStroke("black"),a.getLayer().draw()}),a.on("mouseout",function(){b.setStroke("skyblue"),a.getLayer().draw()}),a}function e(){var a=new Kinetic.Image({x:0,y:0,width:0,height:0});return a.oldDrawScene=a.drawScene,a.updateMapjsAttribs=function(a){var b=function(b){return a&&a[b]},c=b("url"),d=b("width"),e=b("height");this.getAttr("image")&&this.getAttr("image").src!==c&&(this.getAttr("image").src=c||""),this.setAttr("mapjs-image-url",c),this.getAttr("width")!==d&&this.setAttr("width",d),this.getAttr("height")!==e&&this.setAttr("height",e),this.setVisible(c)},a.initMapjsImage=function(){var a=this,b=this.getAttr("mapjs-image-url");b&&(this.getAttr("image")||(this.setAttr("image",new Image),this.getAttr("image").onload=function(){a.getLayer().draw()},this.getAttr("image").src=b))},a.drawScene=function(){this.getAttr("image")||this.initMapjsImage(),this.getAttr("mapjs-image-url")&&this.oldDrawScene.apply(this,arguments)},a}var f=25;Kinetic.Idea=function(a){var g=13,h=27,i=this,j=a.text,k=function(a){return new Kinetic.Rect({strokeWidth:1,cornerRadius:10,x:a,y:a,visible:!1})};this.level=a.level,this.mmAttr=a.mmAttr,this.isSelected=!1,this.isActivated=!!a.activated,a.draggable=a.level>1,a.name="Idea",Kinetic.Group.call(this,a),this.rectAttrs={stroke:"#888",strokeWidth:1},this.rect=new Kinetic.Rect({strokeWidth:1,cornerRadius:10}),this.rectbg1=k(8),this.rectbg2=k(4),this.link=c(),this.link.on("click tap",function(){var a=MAPJS.URLHelper.getLink(j);a&&window.open(a,"_blank")}),this.link.on("mouseover",function(){i.link.setActive(!0)}),this.link.on("mouseout",function(){i.link.setActive(!1)}),this.text=new Kinetic.Text({fontSize:12,fontFamily:"Helvetica",lineHeight:1.5,fontStyle:"bold",align:"center"}),this.clip=d(),this.clip.on("click tap",function(){i.fire(":request",{type:"openAttachment",source:"mouse"})}),this.icon=e(),this.add(this.rectbg1),this.add(this.rectbg2),this.add(this.rect),this.add(this.icon),this.add(this.text),this.add(this.link),this.add(this.clip),this.setText=function(a){var c=b(MAPJS.URLHelper.stripLink(a))||(a.length<f?a:a.substring(0,f)+"...");j=a,i.text.setText(c),i.link.setVisible(MAPJS.URLHelper.containsLink(a)),i.setStyle()},this.setText(a.text),this.classType="Idea",this.getNodeAttrs=function(){return i.attrs},this.isVisible=function(a){var b=i.getStage();return b&&b.isRectVisible(new MAPJS.Rectangle(i.getX(),i.getY(),i.getWidth(),i.getHeight()),a)},this.editNode=function(a,b){i.fire(":editing");var c,d=jQuery(i.getLayer().getCanvas().getElement()).offset(),e=_.throttle(function(){c.css({top:d.top+i.getAbsolutePosition().y,left:d.left+i.getAbsolutePosition().x})},10),f=function(a){i.setStyle(),i.getStage().draw(),i.fire(":textChanged",{text:a||j,isNew:b}),c.remove(),i.stopEditing=void 0,i.getStage().off("xChange yChange",e)},k=function(){""===c.val()?l():f(c.val())},l=function(){f(j),b&&i.fire(":request",{type:"undo",source:"internal"})},m=i.getStage().getScale().x||1;c=jQuery('<textarea type="text" wrap="soft" class="ideaInput"></textarea>').css({top:d.top+i.getAbsolutePosition().y,left:d.left+i.getAbsolutePosition().x,width:(6+i.getWidth())*m,height:(6+i.getHeight())*m,padding:3*m+"px","font-size":i.text.getFontSize()*m+"px","line-height":"150%","background-color":i.getBackground(),margin:-3*m,"border-radius":i.rect.getCornerRadius()*m+"px",border:2*i.rectAttrs.strokeWidth*m+"px dashed "+i.rectAttrs.stroke,color:i.text.getFill(),overflow:"hidden"}).val(j).appendTo("body").keydown(function(a){if(!a.shiftKey||a.which!==g){if(a.which===g)k();else if(a.which===h)l();else{if(9===a.which)return k(),a.preventDefault(),void i.fire(":request",{type:"addSubIdea",source:"keyboard"});if(83===a.which&&(a.metaKey||a.ctrlKey))return a.preventDefault(),void k();a.shiftKey||90!==a.which||!a.metaKey&&!a.ctrlKey||c.val()===j&&l()}a.stopPropagation()}}).blur(k).focus(function(){a?c[0].setSelectionRange?c[0].setSelectionRange(0,j.length):c.select():c[0].setSelectionRange&&c[0].setSelectionRange(j.length,j.length)}).on("input",function(){var a=new Kinetic.Idea({text:c.val()});c.width(Math.max(c.width(),a.getWidth()*m)),c.height(Math.max(c.height(),a.getHeight()*m))}),i.stopEditing=l,c.focus(),i.getStage().on("xChange yChange",e)}}}(),Kinetic.Idea.prototype.setShadowOffset=function(a){"use strict";a=this.getMMScale().x*a,_.each([this.rect,this.rectbg1,this.rectbg2],function(b){b.setShadowOffset([a,a])})},Kinetic.Idea.prototype.getMMScale=function(){"use strict";var a=this.getStage(),b=a&&a.getScaleX()||this.getScaleX()||1;return{x:b,y:b}},Kinetic.Idea.prototype.setupShadows=function(){"use strict";var a=this.getMMScale().x,b=this.isSelected,c=this.isCollapsed()?3*a:4*a,d={color:"black",blur:10*a,offset:[c,c],opacity:.4*a},e={color:"black",blur:0,offset:[c,c],opacity:1},f=b?e:d;this.oldShadow&&this.oldShadow.selected===b&&this.oldShadow.scale===a&&this.oldShadow.offset===c||(this.oldShadow={selected:b,scale:a,offset:c},_.each([this.rect,this.rectbg1,this.rectbg2],function(a){a.setShadowColor(f.color),a.setShadowBlur(f.blur),a.setShadowOpacity(f.opacity),a.setShadowOffset(f.offset)}))},Kinetic.Idea.prototype.getBackground=function(){"use strict";var a=1===this.level,b=MAPJS.defaultStyles[a?"root":"nonRoot"].background,c=function(a,b){if(!a)return b;var c=Color(a).hexString();return a.toUpperCase()===c.toUpperCase()?a:b};return c(this.mmAttr&&this.mmAttr.style&&this.mmAttr.style.background,b)},Kinetic.Idea.prototype.setStyle=function(){"use strict";var a,b,c=this,d=this.isDroppable,e=this.isSelected,f=this.isActivated,g=this.getBackground(),h=Color(g).mix(Color("#EEEEEE")).hexString(),i=4,j=8,k=c.mmAttr&&c.mmAttr.attachment,l=k?c.clip.getClipMargin():0,m=function(){return c.isActivated?[5,3]:[]},n={width:this.text.getWidth(),height:this.text.getHeight()},o=function(a){return{width:a.width+2*j,height:a.height+2*j}},p=function(){var a=c.mmAttr&&c.mmAttr.icon&&c.mmAttr.icon.position;a&&"center"!==a?"bottom"===a?(c.text.setX((b.width-c.text.getWidth())/2),c.text.setY(l+j),c.icon.setY(l+b.height-c.icon.getHeight()-j),c.icon.setX((b.width-c.icon.getWidth())/2)):"top"===a?(c.text.setX((b.width-c.text.getWidth())/2),c.icon.setY(l+j),c.text.setY(l+b.height-c.text.getHeight()-j),c.icon.setX((b.width-c.icon.getWidth())/2)):"left"===a?(c.text.setX(b.width-c.text.getWidth()-j),c.text.setY((b.height-c.text.getHeight())/2+l),c.icon.setY((b.height-c.icon.getHeight())/2+l),c.icon.setX(j)):"right"===a&&(c.text.setY((b.height-c.text.getHeight())/2+l),c.text.setX(j),c.icon.setY((b.height-c.icon.getHeight())/2+l),c.icon.setX(b.width-c.icon.getWidth()-j)):(c.text.setX((b.width-c.text.getWidth())/2),c.text.setY((b.height-c.text.getHeight())/2+l),c.icon.setY((b.height-c.icon.getHeight())/2+l),c.icon.setX((b.width-c.icon.getWidth())/2))},q=function(a,b){return"bottom"===b.position||"top"===b.position?{width:Math.max(a.width,b.width)+2*j,height:a.height+b.height+3*j}:"left"===b.position||"right"===b.position?{width:a.width+b.width+3*j,height:Math.max(a.height,b.height)+2*j}:o({width:Math.max(a.width,b.width),height:Math.max(a.height,b.height)})};if(b=this.mmAttr&&this.mmAttr.icon&&this.mmAttr.icon.url?q(n,this.mmAttr.icon):o(n),this.icon.updateMapjsAttribs(c.mmAttr&&c.mmAttr.icon),this.clip.setVisible(l),this.setWidth(b.width),this.setHeight(b.height+l),this.link.setX(b.width-2*j+10),this.link.setY(b.height-2*j+5+l),p(),a=l,_.each([this.rect,this.rectbg2,this.rectbg1],function(f){f.setWidth(b.width),f.setHeight(b.height),f.setY(a),a+=i,d?(f.setStroke("#9F4F4F"),f.setFill("#EF6F6F")):e?f.setFill(g):(f.setStroke(c.rectAttrs.stroke),f.setFill(g))}),f){this.rect.setStroke("#2E9AFE");var r=[[5,3,0,0],[4,3,1,0],[3,3,2,0],[2,3,3,0],[1,3,4,0],[0,3,5,0],[0,2,5,1],[0,1,5,2]];c.rect.setDashArray(r[0])}else this.activeAnimation&&this.activeAnimation.stop(),this.rect.setDashArray([]);this.rect.setDashArray(m()),this.rect.setStrokeWidth(this.isActivated?3:c.rectAttrs.strokeWidth),this.rectbg1.setVisible(this.isCollapsed()),this.rectbg2.setVisible(this.isCollapsed()),this.clip.setX(b.width-j),this.setupShadows(),this.text.setFill(MAPJS.contrastForeground(h))},Kinetic.Idea.prototype.setMMAttr=function(a){"use strict";this.mmAttr=a,this.setStyle()},Kinetic.Idea.prototype.getIsSelected=function(){"use strict";return this.isSelected},Kinetic.Idea.prototype.isCollapsed=function(){"use strict";return this.mmAttr&&this.mmAttr.collapsed||!1},Kinetic.Idea.prototype.setIsSelected=function(a){"use strict";this.isSelected=a,this.setStyle(),this.getLayer().draw(),!a&&this.stopEditing&&this.stopEditing()},Kinetic.Idea.prototype.setIsActivated=function(a){"use strict";this.isActivated=a,this.setStyle()},Kinetic.Idea.prototype.setIsDroppable=function(a){"use strict";this.isDroppable=a,this.setStyle(this.attrs)},Kinetic.Util.extend(Kinetic.Idea,Kinetic.Group),Kinetic.Stage.prototype.isRectVisible)throw"isRectVisible already exists, should not mix in our methods";Kinetic.Tween.prototype.reset=function(){"use strict";return this.tween.reset(),this},MAPJS.Rectangle=function(a,b,c,d){"use strict";this.scale=function(e){return new MAPJS.Rectangle(a*e,b*e,c*e,d*e)},this.translate=function(e,f){return new MAPJS.Rectangle(a+e,b+f,c,d)},this.inset=function(e){return new MAPJS.Rectangle(a+e,b+e,c-2*e,d-2*e)},this.xscale=function(a){return this.x*=a,this.y*=a,this.width*=a,this.height*=a,this},this.xtranslate=function(a,b){return this.x+=a,this.y+=b,this},this.xinset=function(a){return this.x+=a,this.y+=a,this.width-=2*a,this.height-=2*a,this},this.x=a,this.y=b,this.height=d,this.width=c},Kinetic.Stage.prototype.isRectVisible=function(a,b){"use strict";b=b||{x:0,y:0,margin:0};var c=this.getScale().x||1;return a=a.xscale(c).xtranslate(b.x,b.y).xinset(b.margin),!(a.x+this.getX()>this.getWidth()||a.x+a.width+this.getX()<0||a.y+this.getY()>this.getHeight()||a.y+a.height+this.getY()<0)},MAPJS.KineticMediator=function(a,b){"use strict";window.stage=b;var c=new Kinetic.Layer,d={},e={},f=function(a,b){return a+"_"+b},g=function(a,c,d){var e=.1*Math.min(b.getHeight(),b.getWidth());return _.find(a,function(a){return a.isVisible({x:c,y:d,margin:e})})},h=function(a,c){var f,h;b&&(h=g(d,0,0)||g(e,0,0),f=g(d,a,c)||g(e,a,c),(f||!h)&&(0!==c&&b.setY(b.getY()+c),0!==a&&b.setX(b.getX()+a),b.draw()))},i=function(){new Kinetic.Tween({node:b,x:.5*b.getWidth(),y:.5*b.getHeight(),scaleX:1,scaleY:1,easing:Kinetic.Easings.EaseInOut,duration:.05,onFinish:function(){b.fire(":scaleChangeComplete")}}).play()},j=function(a){var c=b.getScale().x||1,d=100,e={x:0,y:0};a.getIsSelected()&&(a.getAbsolutePosition().x+a.getWidth()*c+d>b.getWidth()?e.x=b.getWidth()-(a.getAbsolutePosition().x+a.getWidth()*c+d):a.getAbsolutePosition().x<d&&(e.x=d-a.getAbsolutePosition().x),a.getAbsolutePosition().y+a.getHeight()*c+d>b.getHeight()?e.y=b.getHeight()-(a.getAbsolutePosition().y+a.getHeight()*c+d):a.getAbsolutePosition().y<d&&(e.y=d-a.getAbsolutePosition().y),new Kinetic.Tween({node:b,x:b.getX()+e.x,y:b.getY()+e.y,duration:.4,easing:Kinetic.Easings.EaseInOut}).play())};b.add(c),c.on("mouseover",function(){b.getContainer().style.cursor="pointer"}),c.on("mouseout",function(){b.getContainer().style.cursor="auto"}),a.addEventListener("addLinkModeToggled",function(a){b.getContainer().style.cursor=a?"crosshair":"auto",c.off("mouseover mouseout"),c.on("mouseover",function(){b.getContainer().style.cursor=a?"alias":"pointer"}),c.on("mouseout",function(){b.getContainer().style.cursor=a?"crosshair":"auto"})}),a.addEventListener("nodeEditRequested",function(a,b,c){var e=d[a];e&&e.editNode(b,c)}),a.addEventListener("nodeCreated",function(e){var f=new Kinetic.Idea({level:e.level,x:e.x,y:e.y,text:e.title,mmAttr:e.attr,opacity:1,id:"node_"+e.id,activated:e.activated});f.on("click tap",function(b){a.clickNode(e.id,b)}),f.on("dblclick dbltap",function(){return a.getEditingEnabled()?void a.editNode("mouse",!1,!1):void a.toggleCollapse("mouse")}),f.on(":textChanged",function(b){a.updateTitle(e.id,b.text,b.isNew),a.setInputEnabled(!0)}),f.on(":editing",function(){a.setInputEnabled(!1)}),f.on(":request",function(b){a[b.type](b.source,e.id)}),e.level>1&&(f.on("mouseover touchstart",b.setDraggable.bind(b,!1)),f.on("mouseout touchend",b.setDraggable.bind(b,!0))),c.add(f),b.on(":scaleChangeComplete",function(){f.setupShadows()}),d[e.id]=f},1),a.addEventListener("nodeSelectionChanged",function(a,b){var c=d[a];c&&(c.setIsSelected(b),b&&j(c))}),a.addEventListener("nodeAttrChanged",function(a){var b=d[a.id];b.setMMAttr(a.attr)}),a.addEventListener("nodeDroppableChanged",function(a,b){var c=d[a];c.setIsDroppable(b)}),a.addEventListener("nodeRemoved",function(a){var b=d[a.id];delete d[a.id],b.off("click dblclick tap dbltap dragstart dragmove dragend mouseover mouseout touchstart touchend :openAttachmentRequested :editing :textChanged "),new Kinetic.Tween({node:b,opacity:.25,easing:Kinetic.Easings.EaseInOut,duration:.2,onFinish:b.destroy.bind(b)}).play()}),a.addEventListener("nodeMoved",function(a,b){var c=d[a.id];new Kinetic.Tween({node:c,x:a.x,y:a.y,easing:"failed"===b?Kinetic.Easings.BounceEaseOut:Kinetic.Easings.EaseInOut,duration:.4,onFinish:j.bind(void 0,c)}).play()}),a.addEventListener("nodeTitleChanged",function(a){var b=d[a.id];b.setText(a.title)}),a.addEventListener("connectorCreated",function(a){var b=new Kinetic.Connector({id:"connector_"+a.to,shapeFrom:d[a.from],shapeTo:d[a.to],stroke:"#888",strokeWidth:1,opacity:0});e[f(a.from,a.to)]=b,c.add(b),b.moveToBottom(),new Kinetic.Tween({node:b,opacity:1,easing:Kinetic.Easings.EaseInOut,duration:.1}).play()}),a.addEventListener("layoutChangeComplete",function(){b.draw()}),a.addEventListener("connectorRemoved",function(a){var b=f(a.from,a.to),c=e[b];delete e[b],new Kinetic.Tween({node:c,opacity:0,easing:Kinetic.Easings.EaseInOut,duration:.1,onFinish:c.destroy.bind(c)}).play()}),a.addEventListener("linkCreated",function(b){var e=new Kinetic.Link({id:"link_"+b.ideaIdFrom+"_"+b.ideaIdTo,shapeFrom:d[b.ideaIdFrom],shapeTo:d[b.ideaIdTo],dashArray:[8,8],stroke:"#800",strokeWidth:1.5});e.on("click tap",function(c){a.selectLink("mouse",b,{x:c.layerX,y:c.layerY})}),c.add(e),e.moveToBottom(),e.setMMAttr(b.attr)}),a.addEventListener("linkRemoved",function(a){var b=c.get("#link_"+a.ideaIdFrom+"_"+a.ideaIdTo)[0];b.destroy()}),a.addEventListener("linkAttrChanged",function(a){var b=c.get("#link_"+a.ideaIdFrom+"_"+a.ideaIdTo)[0];b.setMMAttr(a.attr)}),a.addEventListener("mapScaleChanged",function(a,c){var d=b.getScale().x||1,e=Math.max(Math.min(d*a,5),.2);d!==e&&(c=c||{x:.5*b.getWidth(),y:.5*b.getHeight()},new Kinetic.Tween({node:b,x:c.x+(b.getX()-c.x)*e/d,y:c.y+(b.getY()-c.y)*e/d,scaleX:e,scaleY:e,easing:Kinetic.Easings.EaseInOut,duration:.01,onFinish:function(){b.fire(":scaleChangeComplete")}}).play())}),a.addEventListener("mapViewResetRequested",function(){i()}),a.addEventListener("mapMoveRequested",function(a,b){h(a,b)}),a.addEventListener("activatedNodesChanged",function(a,c){var e=function(a,b){var c=d[b];c&&c.setIsActivated(a)};_.each(a,e.bind(void 0,!0)),_.each(c,e.bind(void 0,!1)),b.draw()}),function(){var a,c;b.on("dragmove",function(){var f=a-b.getX(),i=c-b.getY(),j=g(d,0,0)||g(e,0,0),k=!j&&!(g(d,f,i)||g(e,f,i));k?h(f,i):(a=b.getX(),c=b.getY())})}()},MAPJS.calculateMergedBoxSize=function(a,b){"use strict";return"bottom"===b.position||"top"===b.position?{width:Math.max(a.width,b.width),height:a.height+b.height}:"left"===b.position||"right"===b.position?{width:a.width+b.width,height:Math.max(a.height,b.height)}:{width:Math.max(a.width,b.width),height:Math.max(a.height,b.height)}},MAPJS.KineticMediator.dimensionProvider=_.memoize(function(a){"use strict";var b=new Kinetic.Idea({text:a.title,mmAttr:a.attr});return{width:b.getWidth(),height:b.getHeight()}},function(a){"use strict";var b=a.attr&&a.attr.icon&&":"+a.attr.icon.width+"x"+a.attr.icon.height+"x"+a.attr.icon.position||":0x0x0";return a.title+b}),MAPJS.KineticMediator.layoutCalculator=function(a){"use strict";return MAPJS.calculateLayout(a,MAPJS.KineticMediator.dimensionProvider)},jQuery.fn.mapToolbarWidget=function(a){"use strict";var b=["insertIntermediate","scaleUp","scaleDown","addSubIdea","editNode","removeSubIdea","toggleCollapse","addSiblingIdea","undo","redo","copy","cut","paste","resetView","openAttachment","toggleAddLinkMode","activateChildren","activateNodeAndChildren","activateSiblingNodes","editIcon"],c=["updateStyle"];return this.each(function(){var d=jQuery(this),e=!1;a.addEventListener("nodeSelectionChanged",function(){e=!0,d.find(".updateStyle[data-mm-target-property]").val(function(){return a.getSelectedStyle(jQuery(this).data("mm-target-property"))}).change(),e=!1}),a.addEventListener("addLinkModeToggled",function(){d.find(".toggleAddLinkMode").toggleClass("active")}),b.forEach(function(b){d.find("."+b).click(function(){a[b]&&a[b]("toolbar")})}),c.forEach(function(b){d.find("."+b).change(function(){if(!e){var c=jQuery(this);c.data("mm-target-property")&&a[b]("toolbar",c.data("mm-target-property"),c.val())}})})})},MAPJS.pngExport=function(a){"use strict";var b=jQuery.Deferred(),c=MAPJS.calculateLayout(a,MAPJS.KineticMediator.dimensionProvider),d=MAPJS.calculateFrame(c.nodes,10),e=jQuery("<div></div>").css("visibility","hidden").appendTo("body").width(d.width).height(d.height).attr("id","hiddencontainer"),f=new Kinetic.Stage({container:"hiddencontainer"}),g=new Kinetic.Layer,h=new Kinetic.Layer,i={},j=new Kinetic.Rect({fill:"#ffffff",x:d.left,y:d.top,width:d.width,height:d.height});return f.add(h),h.add(j),f.add(g),f.setWidth(d.width),f.setHeight(d.height),f.setX(-1*d.left),f.setY(-1*d.top),_.each(c.nodes,function(a){var b=new Kinetic.Idea({level:a.level,x:a.x,y:a.y,text:a.title,mmAttr:a.attr});i[a.id]=b,g.add(b)}),_.each(c.connectors,function(a){var b=new Kinetic.Connector({shapeFrom:i[a.from],shapeTo:i[a.to],stroke:"#888",strokeWidth:1});g.add(b),b.moveToBottom()}),_.each(c.links,function(a){var b=new Kinetic.Link({shapeFrom:i[a.ideaIdFrom],shapeTo:i[a.ideaIdTo],dashArray:[8,8],stroke:"#800",strokeWidth:1.5});g.add(b),b.moveToBottom(),b.setMMAttr(a.attr)}),f.draw(),f.toDataURL({callback:function(a){b.resolve(a),e.remove()}}),b.promise()},jQuery.fn.mapWidget=function(a,b,c,d){"use strict";return this.each(function(){var a,e=jQuery(this),f=new Kinetic.Stage({container:this.id,draggable:!0}),g=(new MAPJS.KineticMediator(b,f),function(){f.setWidth(e.width()),f.setHeight(e.height()),f.draw()}),h=!0,i=function(b){var c=a&&a.type!==b.type&&b.timeStamp-a.timeStamp<250;return a=b,!c},j={"return":"addSiblingIdea","del backspace":"removeSubIdea","tab insert":"addSubIdea",left:"selectNodeLeft",up:"selectNodeUp",right:"selectNodeRight","shift+right":"activateNodeRight","shift+left":"activateNodeLeft","shift+up":"activateNodeUp","shift+down":"activateNodeDown",down:"selectNodeDown","space f2":"editNode",f:"toggleCollapse","c meta+x ctrl+x":"cut","p meta+v ctrl+v":"paste","y meta+c ctrl+c":"copy","u meta+z ctrl+z":"undo","shift+tab":"insertIntermediate","Esc 0 meta+0 ctrl+0":"resetView","r meta+shift+z ctrl+shift+z meta+y ctrl+y":"redo","meta+plus ctrl+plus z":"scaleUp","meta+minus ctrl+minus shift+z":"scaleDown","meta+up ctrl+up":"moveUp","meta+down ctrl+down":"moveDown","ctrl+shift+v meta+shift+v":"pasteStyle",Esc:"cancelCurrentAction"},k={"[":"activateChildren","{":"activateNodeAndChildren","=":"activateSiblingNodes",".":"activateSelectedNode","/":"toggleCollapse",a:"openAttachment",i:"editIcon"},l=function(a,c,d,e){d=d||0,e=e||0,a.target===jQuery(f.getContainer()).find("canvas")[0]&&(Math.abs(d)<5&&(d=5*d),Math.abs(e)<5&&(e=5*e),b.move("mousewheel",-1*d,e),a.preventDefault&&a.preventDefault())};_.each(j,function(a,c){jQuery(document).keydown(c,function(c){h&&(c.preventDefault(),b[a]("keyboard"))})}),MAPJS.dragdrop(b,f,d),$(document).on("keypress",function(a){if(h&&!/INPUT|TEXTAREA/.test(a&&a.target&&a.target.tagName)){var c=a.charCode||a.keyCode,d=String.fromCharCode(c),e=k[d];e?(a.preventDefault(),b[e]("keyboard")):Number(d)<=9&&Number(d)>=1&&(a.preventDefault(),b.activateLevel("keyboard",Number(d)+1))}}),e.data("mm-stage",f),b.addEventListener("inputEnabledChanged",function(a){h=a}),g(),f.setX(.5*f.getWidth()),f.setY(.5*f.getHeight()),jQuery(window).bind("orientationchange resize",g),$(document).on("contextmenu",function(a){return a.preventDefault(),a.stopPropagation(),!1}),e.on("mousedown touch",function(a){window.focus(),document.activeElement!==a.target&&document.activeElement.blur()}),c?e.find("canvas").hammer().on("pinch",function(a){i(a)&&b.scale("touch",a.gesture.scale,{x:a.gesture.center.pageX-e.offset().left,y:a.gesture.center.pageY-e.offset().top})}).on("swipe",function(a){i(a)&&b.move("touch",a.gesture.deltaX,a.gesture.deltaY)}).on("doubletap",function(){b.resetView()}).on("touch",function(){jQuery(".topbar-color-picker:visible").hide(),jQuery(".ideaInput:visible").blur()}):jQuery(window).mousewheel(l)})},jQuery.fn.linkEditWidget=function(a){"use strict";return this.each(function(){var b,c,d,e,f,g,h=jQuery(this);e=h.find(".color"),f=h.find(".lineStyle"),g=h.find(".arrow"),a.addEventListener("linkSelected",function(a,i,j){b=a,h.show(),c=c||h.width(),d=d||h.height(),h.css({top:i.y-.5*d-15+"px",left:i.x-.5*c-15+"px"}),e.val(j.color).change(),f.val(j.lineStyle),g[j.arrow?"addClass":"removeClass"]("active")}),a.addEventListener("mapMoveRequested",function(){h.hide()}),h.find(".delete").click(function(){a.removeLink("mouse",b.ideaIdFrom,b.ideaIdTo),h.hide()}),e.change(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"color",jQuery(this).val())}),f.find("a").click(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"lineStyle",jQuery(this).text())}),g.click(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"arrow",!g.hasClass("active"))}),h.mouseleave(h.hide.bind(h))})},MAPJS.getDataURIAndDimensions=function(a,b){"use strict";var c=function(a){return/^data:image/.test(a)},d=function(a){if(c(a.src))return a.src;var b=document.createElement("canvas");b.width=a.width,b.height=a.height;var d=b.getContext("2d");return d.drawImage(a,0,0),b.toDataURL("image/png")},e=jQuery.Deferred(),f=new Image;return f.onload=function(){try{e.resolve({dataUri:d(f),width:f.width,height:f.height})}catch(a){e.reject()}},f.onerror=function(){e.reject()},c(a)||(b?(f.crossOrigin="Anonymous",a=b+encodeURIComponent(a)):e.reject("no-cors")),f.src=a,e.promise()},MAPJS.ImageInsertController=function(a){"use strict";var b=observable(this),c=function(a){var b=jQuery.Deferred(),c=new FileReader;return c.onload=function(a){b.resolve(a.target.result)},c.onerror=b.reject,c.onprogress=b.notify,c.readAsDataURL(a),b.promise()};b.insertDataUrl=function(c,d){b.dispatchEvent("imageLoadStarted"),MAPJS.getDataURIAndDimensions(c,a).then(function(a){b.dispatchEvent("imageInserted",a.dataUri,a.width,a.height,d)},function(a){b.dispatchEvent("imageInsertError",a)})},b.insertFiles=function(a,d){jQuery.each(a,function(a,e){/^image\//.test(e.type)&&jQuery.when(c(e)).done(function(a){b.insertDataUrl(a,d)})})},b.insertHtmlContent=function(a,c){var d=a.match(/img[^>]*src="([^"]*)"/);d&&d.length>0&&_.each(d.slice(1),function(a){b.insertDataUrl(a,c)})}},jQuery.fn.imageDropWidget=function(a){"use strict";return this.on("dragenter dragover",function(a){return a.originalEvent.dataTransfer?!1:void 0}).on("drop",function(b){var c,d=b.originalEvent.dataTransfer;b.stopPropagation(),b.preventDefault(),d&&d.files&&d.files.length>0?a.insertFiles(d.files,b.originalEvent):d&&(c=d.getData("text/html"),a.insertHtmlContent(c,b.originalEvent))}),this},MM.ActivityLog=function(a){"use strict";var b=[],c=1,d=this;observable(this),this.log=function(){var e=["log"];b.length===a&&b.shift(),b.push({id:c,ts:new Date,event:Array.prototype.join.call(arguments,",")}),c+=1,Array.prototype.slice.call(arguments).forEach(function(a){jQuery.isArray(a)?e=e.concat(a):e.push(a)}),d.dispatchEvent.apply(d,e)},this.error=function(a){d.log("Error",a),d.dispatchEvent("error",a,b)},this.getLog=b.slice.bind(b),this.timer=function(a,b){var c=Date.now();return{end:function(){d.dispatchEvent("timer",a,b,Date.now()-c)}}}},jQuery.fn.trackingWidget=function(a){"use strict";return this.each(function(){var b=jQuery(this),c=b.data("category"),d=b.data("event-type")||"",e=b.data("label")||"";b.click(function(){a.log(c,d,e)})})},MM.Alert=function(){"use strict";var a=this,b=1;observable(this),this.show=function(c,d,e){var f=b;return b+=1,a.dispatchEvent("shown",f,c,d,"flash"===e?"info":e),"flash"===e&&setTimeout(function(){a.hide(f)},3e3),f},this.hide=this.dispatchEvent.bind(this,"hidden")},jQuery.fn.alertWidget=function(a){"use strict";return this.each(function(){var b=jQuery(this);a.addEventListener("shown",function(a,c,d,e){e=e||"info",d=d||"",b.append('<div class="alert fade in alert-'+e+" alert-no-"+a+'"><button type="button" class="close" data-dismiss="alert">&#215;</button><strong>'+c+"</strong>&nbsp;"+d+"</div>")}),a.addEventListener("hidden",function(a){b.find(".alert-no-"+a).remove()})})},MM.AutoSave=function(a,b,c){"use strict";var d,e,f="auto-save-",g=this,h=[],i=!1,j=function(a){var c=b.getItem(f+a);c&&g.dispatchEvent("unsavedChangesAvailable",a)},k=function(a,d){h=[],a.addEventListener("changed",function(a,e){h.push({cmd:a,args:e});try{b.setItem(f+d,h)}catch(g){i||(i=!0,c.show("Problem with auto save!","We could not autosave the changes - there is not enough free space in your local browser repository.","warning"))}})};observable(this),g.applyUnsavedChanges=function(){var a=b.getItem(f+d);a&&a.forEach(function(a){e.execCommand(a.cmd,a.args)})},g.discardUnsavedChanges=function(){h=[],b.remove(f+d)},a.addEventListener("mapSaved",function(a,b){i=!1,(a===d||b===e)&&g.discardUnsavedChanges()}),a.addEventListener("mapLoaded",function(a,b,c){c&&c.autoSave||(d=a,e=b,i=!1,j(a),k(b,a))})},$.fn.background_upload=function(a,b,c,d){"use strict";var e=this,f=$("iframe").length,g=!1;return b=b||function(a){console.log("Uploading",a)},c=c||function(a){console.log("Uploaded",a)},d=d||function(a){console.log("Upload error",a)},$('<iframe style="display:none" name="upload-'+f+'"></iframe>').appendTo("body").load(function(){var a,b=g;if(g){g=!1;try{a=$(this.contentWindow.document.body).text()}catch(e){return void d("problem uploading the file to server",a)}c(a,b)}}),e.wrap('<form enctype="multipart/form-data" method="post" action="'+a+'" target="upload-'+f+'">'),e.parents("form").submit(function(){var a=(e.val()||"").replace(/.*[\\\/]/g,"");return g=a.split(".").pop(),"mm"!==g&&"mup"!==g?(d("unsupported type "+g),g=!1,!1):void b(a)}),e.change(function(){e.parents("form").submit()}),e},MM.jsonStorage=function(a){"use strict";var b={};return b.setItem=function(b,c){return a.setItem(b,JSON.stringify(c))},b.getItem=function(b){var c=a.getItem(b);try{return JSON.parse(c)}catch(d){}},b.remove=function(b){a.removeItem(b)},b},MM.Bookmark=function(a,b,c){"use strict";var d=observable(this),e=!1,f=[],g=function(){b&&c&&b.setItem(c,f)};b&&c&&(f=b.getItem(c)||[]),a.addEventListener("mapSaved",function(a,b){var c=d.canPin();e={mapId:a,title:b.title},d.store({mapId:a,title:b.title}),c!==d.canPin()&&d.dispatchEvent("pinChanged")}),a.addEventListener("mapLoaded",function(a,b){var c=d.canPin();e={mapId:a,title:b.title},c!==d.canPin()&&d.dispatchEvent("pinChanged")}),d.store=function(a){if(!a.mapId||!a.title)throw new Error("Invalid bookmark");var b=_.find(f,function(b){return b.title===a.title||b.mapId===a.mapId});b?(b.mapId=a.mapId,b.title=a.title):f.push(_.clone(a)),g(),d.dispatchEvent("added",a)},d.remove=function(a,b){var c,e;for(b=b||!1,c=0;c<f.length;c++)if(f[c].mapId===a)return e=f.splice(c,1)[0],g(),void d.dispatchEvent("deleted",e,b)},d.list=function(){return _.clone(f).reverse()},d.links=function(a){return a=a||30,_.map(d.list(),function(b){return{title:b.title,shortTitle:b.title.length>a?b.title.substr(0,a)+"...":b.title,mapId:b.mapId}})},d.pin=function(){e&&d.store(e)},d.canPin=function(){return e&&(0===f.length||_.every(f,function(a){return a.mapId!==e.mapId}))}},jQuery.fn.bookmarkWidget=function(a,b,c){"use strict";return this.each(function(){var d,e=jQuery(this),f=e.find(".template").detach(),g=e.find("[data-mm-role=bookmark-pin]"),h=e.children().filter("[data-mm-role=bookmark]").clone(),i=function(){var b,d,i,j=a.links();e.children().filter("[data-mm-role=bookmark]").remove(),g.parent().hide(),a.canPin()&&g.parent().show(),j.length?j.slice(0,10).forEach(function(g){i=f.clone().show().attr("data-mm-role","bookmark").appendTo(e),b=i.find("a"),d=b.children().detach(),b.click(function(){c.loadMap(g.mapId)
}),b.text(g.shortTitle).addClass("repo-"+g.mapId[0]),d.appendTo(b),i.find("[data-mm-role=bookmark-delete]").click(function(){return a.remove(g.mapId),e.parents(".dropdown").find(".dropdown-toggle").dropdown("toggle"),!1})}):e.append(h.clone())};g.click(function(){a.pin()}),a.addEventListener("added",i),a.addEventListener("pinChanged",i),a.addEventListener("deleted",function(c,e){i(),b&&!e&&(d&&b.hide(d),d=b.show("Bookmark Removed.",c.title+' was removed from the list of your maps. <a href="#"> Undo </a> ',"success"),jQuery(".alert-no-"+d).find("a").click(function(){a.store(c),b.hide(d)}))}),i()})},jQuery.fn.classCachingWidget=function(a,b){"use strict";var c=jQuery(this),d=a+"-"+c.selector;return jQuery(window).unload(function(){b[d]=c.attr("class")}),c.addClass(b[d]),this},MM.EmbeddedMapUrlGenerator=function(a){"use strict";var b=this;b.buildMapUrl=function(b){var c=b&&b[0],d=c&&a[c],e=jQuery.Deferred();return d?e.resolve((d.prefix||"")+b.slice(d.remove)+(d.postfix||"")):e.reject(),e.promise()}},MM.Extensions=function(a,b,c,d){"use strict";var e=[],f=function(a,b,c,d,e){c.forEach(function(c){var f,g=a.getElementsByTagName(b)[0];f=a.createElement(b),f.src=("file:"===document.location.protocol?"http:":"")+c,f.onload=d,f.onerror=e,g.parentNode.insertBefore(f,g)})},g=function(a){return _.flatten(_.reject(_.map(a,function(a){return MM.Extensions.config[a]&&MM.Extensions.config[a].script.split(" ")}),function(a){return!a}))};a[b]&&(e=a[b].split(" ")),this.requiredExtension=function(a){var b,c;for(b in MM.Extensions.config)if(c=MM.Extensions.config[b],c.providesMapId&&c.providesMapId(a))return b},this.scriptsToLoad=function(a){var b=this.requiredExtension(a),d=b?_.union(e,b):e,f=g(d);return _.map(f,function(a){return/^http[s]?:/.test(a)?a:"/"+c.cachePreventionKey+a})},this.isActive=function(a){return _.contains(e,a)},this.setActive=function(c,f){e=f?_.union(e,[c]):_.without(e,c),a[b]=e.join(" "),d&&d.activityLog&&d.activityLog.log("Extensions",c,"act-"+f)},this.load=function(a){var b,e,g=jQuery.Deferred(),h=this.scriptsToLoad(a);return MM.Extensions.components=d,MM.Extensions.mmConfig=c,f(document,"script",c.scriptsToLoadAsynchronously.split(" ")),MM.Extensions.pendingScripts=_.invert(h),f(document,"script",h,function(){delete MM.Extensions.pendingScripts[jQuery(this).attr("src")]},function(){d.alert.hide(b),window.clearInterval(e),d.alert.show("A required extension failed to load due to a network error.",'You may continue to use the site but some features may not be available. Please reload the page when you reconnect to the Internet to activate all the features. If the error persists, please contact us at <a href="mailto:contact@mindmup.com">contact@mindmup.com</a>',"error"),g.resolve()}),_.isEmpty(MM.Extensions.pendingScripts)?g.resolve():(b=d.alert.show('<i class="icon-spinner icon-spin"></i>&nbsp;Please wait, loading extensions...<span data-mm-role="num-extensions"></span>'),e=window.setInterval(function(){_.isEmpty(MM.Extensions.pendingScripts)?(d.alert.hide(b),window.clearInterval(e),g.resolve()):jQuery("[data-mm-role=num-extensions]").text(_.size(MM.Extensions.pendingScripts)+" remaining")},1e3)),g.promise()}},MM.Extensions.config={"goggle-collaboration":{name:"Realtime collaboration",script:"/e/google-collaboration.js",icon:"icon-group",doc:"http://blog.mindmup.com/p/realtime-collaboration.html",desc:"Realtime collaboration on a map, where several people can concurrently change it and updates are shown to everyone almost instantly. Collaboration is persisted using Google Drive.",providesMapId:function(a){"use strict";return/^cg/.test(a)}},progress:{name:"Progress",script:"/e/progress.js",icon:"icon-dashboard",doc:"http://blog.mindmup.com/p/monitoring-progress.html",desc:"Progress allows you to manage hierarchies of tasks faster by propagating statuses to parent nodes. For example, when all sub-tasks are completed, the parent task is marked as completed automatically.",aggregateAttributeName:"progress-statuses",measurementsConfigName:"measurements-config",isActiveOnMapContent:function(a){"use strict";return a.getAttr(MM.Extensions.config.progress.aggregateAttributeName)}},"straight-lines":{name:"Straight lines",script:"/e/straight-lines.js",icon:"icon-reorder",doc:"http://blog.mindmup.com/p/straight-lines.html",desc:"This extension converts funky curve connectors into straight lines, which makes it clearer to see what connects to what on large maps"},github:{name:"Github",script:"/e/github.js",icon:"icon-github",doc:"http://www.github.com",desc:"Store your maps on Github",providesMapId:function(a){"use strict";return/^h/.test(a)}},dropbox:{name:"Dropbox",script:"https://www.dropbox.com/static/api/1/dropbox-datastores-0.1.0-b3.js /e/dropbox.js",icon:"icon-dropbox",doc:"http://blog.mindmup.com/p/working-with-dropbox.html",desc:"Store your maps on Dropbox",providesMapId:function(a){"use strict";return/^d1/.test(a)}}},jQuery.fn.extensionsWidget=function(a,b,c){"use strict";var d,e,f=this,g=function(a,b,e,f){d=c.show(a,'<a href="#" data-mm-role="alert-callback">'+b+"</a>",e),jQuery("[data-mm-role=alert-callback]").click(function(){c.hide(d),f()})},h=f.find("[data-mm-role=ext-list]"),i=h.find("[data-mm-role=template]").hide().clone(),j=!1;return _.each(MM.Extensions.config,function(b,c){var d=i.clone().appendTo(h).show();d.find("[data-mm-role=title]").html("&nbsp;"+b.name).addClass(b.icon),d.find("[data-mm-role=doc]").attr("href",b.doc),d.find("[data-mm-role=desc]").prepend(b.desc),d.find("input[type=checkbox]").attr("checked",a.isActive(c)).change(function(){a.setActive(c,this.checked),j=!0})}),f.on("hidden",function(){j&&(e?window.location="/map/"+e:location.reload()),e=void 0}),b.addEventListener("mapIdNotRecognised",function(b){var h=a.requiredExtension(b);c.hide(d),h?g("This map requires an extension to load!","Click here to enable the "+MM.Extensions.config[h].name+" extension","warning",function(){e=b,f.modal("show")}):d=c.show("The URL is unrecognised!","it might depend on a custom extension that is not available to you.","error")}),b.addEventListener("mapLoaded",function(b,h){var i=_.filter(MM.Extensions.config,function(b,c){return b.isActiveOnMapContent&&b.isActiveOnMapContent(h)&&!a.isActive(c)}),j=i.length>1?"s":"";c.hide(d),i.length&&g("This map uses additional extensions!","Click here to enable the "+_.map(i,function(a){return a.name}).join(", ")+" extension"+j,"warning",function(){e=b,f.modal("show")})}),f},MM.JotForm=function(a,b){"use strict";var c=a.find("[name=q1_name]"),d=a.find("textarea"),e=jQuery('<input type="hidden" name="q8_browserInfo" />').appendTo(a),f=jQuery('<input type="hidden" name="q9_activityLog" />').appendTo(a),g=jQuery('<input type="hidden" name="q10_screenInfo" />').appendTo(a),h=jQuery('<input type="hidden" name="q11_pageInfo" />').appendTo(a),i=function(b){e.val(navigator.userAgent),f.val(JSON.stringify(b)),g.val(JSON.stringify(window.screen)+" resolution:"+jQuery(window).width()+"x"+jQuery(window).height()),h.val(window.location.href),a.submit(),d.val("")};this.sendError=function(a,b){d.val(a),c.val("automated error report"),i(b),c.val("")},this.sendFeedback=function(a){b.show("Thank you for your feedback!","We'll get back to you as soon as possible."),i(a)}},jQuery.fn.feedbackWidget=function(a,b){"use strict";return this.each(function(){var c=jQuery(this);c.find(".sendFeedback").click(function(){a.sendFeedback(b.getLog()),c.modal("hide")})})},MM.FileSystemMapSource=function(a){"use strict";var b=this,c="application/json",d=function(a,b){var d;return b===c?d="string"==typeof a?JSON.parse(a):a:"application/octet-stream"===b?d=JSON.parse(a):("application/x-freemind"===b||"application/vnd-freemind"===b)&&(d=MM.freemindImport(a)),MAPJS.content(d)},e=function(a){return/\.mm$/.test(a)?"application/x-freemind":/\.mup$/.test(a)?"application/json":"application/octet-stream"};b.loadMap=function(b,c){var f=jQuery.Deferred(),g={"application/json":!0,"application/octet-stream":!0,"application/x-freemind":!1,"application/vnd-freemind":!1};return a.loadMap(b,c).then(function(a,b,c,h,i){if(!c&&i&&(c=e(i)),h=jQuery.extend({editable:g[c]},h),"application/vnd.mindmup.collab"===c)return f.reject("map-load-redirect","c"+b).promise();if(void 0===g[c])f.reject("format-error","Unsupported format "+c);else try{f.resolve(d(a,c),b,h)}catch(j){f.reject("format-error","File content not in correct format for this file type")}},f.reject,f.notify),f.promise()},b.saveMap=function(b,c,d){var e=jQuery.Deferred(),f=JSON.stringify(b,null,2),g=MM.navigationEscape(b.title)+".mup";return a.saveMap(f,c,g,!!d).then(e.resolve,e.reject,e.notify),e.promise()},b.description=a.description,b.recognises=a.recognises},MM.freemindImport=function(a,b,c){"use strict";var d,e=function(a,b){var c,d={},e=function(a){return $("<div>").append(a).html()};return a.attr("BACKGROUND_COLOR")&&(d.style={background:a.attr("BACKGROUND_COLOR")}),(b&&b.collapsed||"true"===a.attr("FOLDED"))&&(d.collapsed="true"),c=a.children("richcontent").find("body"),c.length>0&&(d.attachment={contentType:"text/html",content:e(c.children())}),d},f=function(a,b){var d=$(a),g={title:d.attr("TEXT")||""},h=d.children("node"),i=e(d,b),j=_.map(h,function(a){return f(a,i)}),k={},l=1;return _.size(i)>0&&(g.attr=i),j.length>0?(_.each(j,function(a){var b="left"===$(h[l-1]).attr("POSITION")?-1:1;k[b*l]=a,l+=1}),g.ideas=k):g.attr&&g.attr.collapsed&&delete g.attr.collapsed,c&&c(),g},g=$($.parseXML(a));return b&&b(g.find("node").length),d=f(g.find("map").children("node").first()),d.formatVersion=2,d},MM.freemindExport=function(a){"use strict";var b=function(a){var c=escape(a.title).replace(/%([0-9A-F][0-9A-F])/g,"&#x$1;").replace(/%u([0-9A-F][0-9A-F][0-9A-F][0-9A-F])/g,"&#x$1;");return'<node ID="'+a.id+'" TEXT="'+c+'">'+(_.size(a.ideas)>0?_.map(_.sortBy(a.ideas,function(a,b){return parseFloat(b)}),b).join(""):"")+"</node>"};return'<map version="0.7.1">'+b(a)+"</map>"},MM.GoldApi=function(a,b,c,d){"use strict";var e=this,f="GoldApi",g=function(a){var b=["not-authenticated","invalid-args","server-error","user-exists","email-exists"];return _.contains(b,a)?a:"network-error"},h=function(b,c,d,f){var g=jQuery.Deferred(),h=function(a){var c=_.extend({},d,{license:JSON.stringify(a)});f&&f!==a.account?g.reject("not-authenticated"):e.exec(b,c).then(function(b){g.resolve(b,a.account)},g.reject)};return a.retrieveLicense(c).then(h,g.reject),g.promise()};e.exec=function(a,d){var e=jQuery.Deferred(),h=function(b){var d=b.responseText;c.log(f,"error",a+":"+d),e.reject(g(d))},i=c.timer(f,a),j=new FormData,k={"license/register":"json","file/export_config":"json","file/upload_config":"json"};return d&&_.each(d,function(a,b){j.append(b,a)}),jQuery.ajax({url:b+"/"+a,dataType:k[a],data:j,processData:!1,contentType:!1,type:"POST"}).then(e.resolve,h).always(i.end),e.promise()},e.register=function(a,b){return e.exec("license/register",{to_email:b,account_name:a})},e.getExpiry=function(){var b=a.getLicense();return e.exec("license/expiry",{license:JSON.stringify(b)})},e.generateExportConfiguration=function(b){var c=a.getLicense();return e.exec("file/export_config",{license:JSON.stringify(c),format:b})},e.listFiles=function(a){var b=jQuery.Deferred(),c=function(a,c){var d=jQuery(a),e=[];d.find("Contents").each(function(){var a=jQuery(this),b=a.children("Key").text(),c=b.indexOf("/")+1;e.push({modifiedDate:a.children("LastModified").text(),title:b.slice(c)})}),b.resolve(e,c)};return h("file/list",a).then(c,b.reject),b.promise()},e.generateSaveConfig=function(a){return h("file/upload_config",a)},e.fileUrl=function(a,b,c,e){return e?h("file/url",a,{file_key:encodeURIComponent(c)},b):jQuery.Deferred().resolve("https://"+d+".s3.amazonaws.com/"+b+"/"+encodeURIComponent(c)).promise()},e.exists=function(b){var c=jQuery.Deferred(),d=a.getLicense();return d?e.exec("file/exists",{license:JSON.stringify(d),file_key:encodeURIComponent(b)}).then(function(a){var b=jQuery(a);c.resolve(b.find("Contents").length>0)},c.reject):c.reject("not-authenticated"),c.promise()}},jQuery.fn.goldLicenseEntryWidget=function(a,b,c){"use strict";var d,e=this,f=!1,g=!1,h=e.find("[data-mm-role~=remove]"),i=e.find("input[type=file]"),j=e.find("[data-mm-role=upload]"),k=function(a,b){b?c.log("Gold",a,b):c.log("Gold",a)},l=function(){var c=a.getLicense(),f=function(a){"view-license"===d&&o("not-authenticated"===a?"invalid-license":"license-server-unavailable")},g=function(a){var b=a&&parseInt(a,10),c=new Date(1e3*b);0===b?f("not-authenticated"):c&&c<new Date?"view-license"===d&&o("expired-license"):e.find("input[data-mm-role~=expiry-date]").val(c&&c.toDateString()||"")};e.find("input[data-mm-role~=account-name]").val(c&&c.account||""),c?(e.find("[data-mm-role~=license-text]").val(JSON.stringify(c)),e.find("input[data-mm-role~=expiry-date]").val("getting expiry date..."),b.getExpiry().then(g,f)):(e.find("[data-mm-role~=license-text]").val(""),e.find("input[data-mm-role~=expiry-date]").val(""))},m=function(b){k("license-set"),a.storeLicense(b)?(g=!0,f?e.modal("hide"):(l(),o("view-license"))):o("invalid-license")},n=function(){var a=j.filter(":visible").first();a.length>0?i.show().css("opacity",0).css("position","absolute").offset(a.offset()).width(a.outerWidth()).height(a.outerHeight()):i.hide()},o=function(a){d=a,k("license-section",a),e.find("[data-mm-section]").not("[data-mm-section~="+a+"]").hide(),e.find("[data-mm-section~="+a+"]").show(),n()},p=function(a,b){return b?a?"unauthorised-license":"license-required":a?"view-license":"no-license"},q=function(a){e.find("[data-mm-role=license-capacity]").text(a.capacity),e.find("[data-mm-role=license-grace-period]").text(a["grace-period"]),e.find("[data-mm-role=license-expiry]").text(new Date(1e3*parseInt(a.expiry,10)).toDateString()),e.find("[data-mm-role=license-email]").text(a.email),e.find("[data-mm-role=license-payment-url]").attr("href",a["payment-url"]),o("registration-success")},r=function(a){e.find("[data-mm-section=registration-fail] .alert [data-mm-role]").hide();var b=e.find("[data-mm-section=registration-fail] .alert [data-mm-role~="+a+"]");b.length>0?b.show():e.find("[data-mm-section=registration-fail] .alert [data-mm-role~=network-error]").show(),o("registration-fail")},s=function(){var a=e.find("[data-mm-section=register] form"),c=a.find("input[name=email]"),d=a.find("input[name=account-name]"),f=a.find("input[name=terms]");return/@/.test(c.val())?c.parents("div.control-group").removeClass("error"):c.parents("div.control-group").addClass("error"),/^[a-z][a-z0-9]{3,20}$/.test(d.val())?d.parents("div.control-group").removeClass("error"):d.parents("div.control-group").addClass("error"),f.prop("checked")?f.parents("div.control-group").removeClass("error"):f.parents("div.control-group").addClass("error"),a.find("div.control-group").hasClass("error")?!1:(b.register(d.val(),c.val()).then(q,r),void o("registration-progress"))};return e.find("form").submit(function(){return this.action}),e.find("[data-mm-role~=form-submit]").click(function(){var a=jQuery(this).data("mm-form");jQuery(a).submit()}),e.find("[data-mm-role=save-license]").click(function(){var a=e.find("textarea[data-mm-role=license-text]").val();m(a)}),e.on("show",function(){k("license-show"),g=!1;var b=a.getLicense();o(p(b,f)),l(b)}),e.on("shown",n),e.on("hidden",function(){g||a.cancelLicenseEntry(),h.show(),f=!1}),h.click(function(){a.removeLicense(),g=!0,l(),o("no-license")}),e.find("button[data-mm-role~=show-section]").click(function(){o(jQuery(this).data("mm-target-section"))}),e.find("button[data-mm-role~=register]").click(s),a.addEventListener("license-entry-required",function(){f=!0,e.modal("show")}),e.modal({keyboard:!0,show:!1}),i.css("opacity",0).hide(),i.file_reader_upload(void 0,m,function(){console.log("fail",arguments),o("invalid-license")},["txt"]),e.find("a").click(function(){k("license-click",this.href)}),e.find("button").click(function(){k("license-click",jQuery(this).text())}),e},MM.GoldLicenseManager=function(a,b){"use strict";var c,d=this,e=function(a){return a&&"mindmup-gold"===a.accountType};observable(this),this.getLicense=function(){return a.getItem(b)},this.retrieveLicense=function(a){return c=void 0,!a&&this.getLicense()?jQuery.Deferred().resolve(this.getLicense()).promise():(c=jQuery.Deferred(),d.dispatchEvent("license-entry-required"),c.promise())},this.storeLicense=function(d){var f,g=c;try{f=JSON.parse(d)}catch(h){return!1}return e(f)?(a.setItem(b,f),c&&(c=void 0,g.resolve(f)),!0):!1},this.removeLicense=function(){a.setItem(b,void 0)},this.cancelLicenseEntry=function(){var a=c;c&&(c=void 0,a.reject("user-cancel"))}},MM.GoldStorage=function(a,b,c,d){"use strict";var e,f=this,g={editable:!0},h=function(a){return a&&d&&d[a]},i=function(a){var b=a&&a.split("/");return b&&b.length<3?!1:h(b[0])?{prefix:b[0],account:b[1],fileNameKey:decodeURIComponent(b[2])}:!1},j=function(a,b,c){return a+"/"+b+"/"+encodeURIComponent(c)};d=_.extend({p:{isPrivate:!0},b:{isPrivate:!1},listPrefix:"b"},d),_.each(d,function(a,b){a.isPrivate&&(e=b)}),f.fileSystemFor=function(a,b){return{recognises:function(b){return b&&b[0]===a},description:b,saveMap:function(b,c,d,e){return f.saveMap(a,b,c,d,e)},loadMap:f.loadMap}},f.list=function(b){var c=jQuery.Deferred(),e=function(a,b){var e=d.listPrefix+"/"+b+"/",f=function(a){return _.extend({id:e+encodeURIComponent(a.title)},a)};c.resolve(_.map(a,f))};return a.listFiles(b).then(e,c.reject),c.promise()},f.saveMap=function(e,f,h,k,l){var m=jQuery.Deferred(),n=function(a,b){return a&&a.fileNameKey&&a.account===b?a.fileNameKey:k},o=function(k,l){var o=i(h),p=n(o,l),q=_.extend({},k,{key:l+"/"+p}),r=function(){return o&&l===o.account?!1:!0},s=function(){m.resolve(j(e,l,p),g)},t=function(){b.save(f,q,d[e]).then(s,m.reject)},u=function(){c.showModalToConfirm("Confirm saving","There is already a file with that name in your gold storage. Please confirm that you want to overwrite it, or cancel and rename the map before saving","Overwrite").then(t,m.reject.bind(m,"user-cancel"))},v=function(){a.exists(p).then(function(a){a?u():t()},m.reject)};r()?v():t()};return a.generateSaveConfig(l).then(o,m.reject),m.promise()},f.loadMap=function(c,f){var h=jQuery.Deferred(),k=i(c),l=function(c,i,k){var m=d[c].isPrivate;a.fileUrl(f,i,k,m).then(function(a){b.loadUrl(a).then(function(a){h.resolve(a,j(c,i,k),"application/json",g)},function(a){"map-not-found"===a&&!m&&e?l(e,i,k):h.reject(a)})},h.reject)};return k?l(k.prefix,k.account,k.fileNameKey):h.reject("invalid-args"),h.promise()}},MM.LayoutExportController=function(a,b,c,d){"use strict";var e="Map",f="PDF Export";this.startExport=function(g,h){var i=jQuery.Deferred(),j=function(){return"pending"!==i.state()},k=function(a,b){d.log(e,f+" failed",a),i.reject(a,b)},l=_.extend({},a.getCurrentLayout(),h);return d.log(e,f+" started"),b.generateExportConfiguration(g).then(function(a){var b=a.s3UploadIdentifier;c.save(JSON.stringify(l),a,{isPrivate:!0}).then(function(){var g=function(){d.log(e,f+" completed"),i.resolve(a.signedOutputUrl)};c.poll(a.signedErrorListUrl,{stoppedSemaphore:j}).then(function(){k("generation-error",b)}),c.poll(a.signedOutputListUrl,{stoppedSemaphore:j}).then(g,function(a){k(a,b)})},k)},k),i.promise()}},jQuery.fn.layoutExportWidget=function(a){"use strict";return this.each(function(){var b=jQuery(this),c=b.data("mm-format"),d=b.find("[data-mm-role=export]"),e=function(a){b.find(".visible").hide(),b.find(".visible."+a).show()},f=function(a){b.find("[data-mm-role=output-url]").attr("href",a),e("done")},g=function(){var a=b.find("form"),c={};return a.find("button.active").add(a.find("select")).each(function(){c[jQuery(this).attr("name")]=jQuery(this).val()}),c},h=function(a,c){b.find("[data-mm-role=contact-email]").attr("href",function(){return"mailto:"+jQuery(this).text()+"?subject=MindMup%20PDF%20Export%20Error%20"+c}),b.find("[data-mm-role=file-id]").html(c),b.find(".error span").hide(),e("error");var d=b.find("[data-mm-role="+a+"]");d.length>0?d.show():b.find("[data-mm-role=error-message]").html(a).show()},i=function(){e("inprogress"),a.startExport(c,{"export":g()}).then(f,h)};b.find("form").submit(function(){return!1}),d.click(i).keydown("space",i),b.modal({keyboard:!0,show:!1}),b.on("show",function(){e("initial")}).on("shown",function(){d.focus()})})},MM.MapController=function(a){"use strict";observable(this);var b,c,d,e=this,f=this.dispatchEvent,g={},h=[].concat(a),i=function(a){var b;for(b=0;b<h.length;b++)if(h[b].recognises(a))return h[b]},j=function(a,c,e){d=e,b=!1,e=e||{},e.autoSave||a.addEventListener("changed",function(){b=!0}),g={idea:a,mapId:e.editable&&c},f("mapLoaded",c,a,e)};e.addMapSource=function(a){h.push(a)},e.validMapSourcePrefixesForSaving="abogp",e.setMap=j,e.isMapLoadingConfirmationRequired=function(){return b},e.currentMapId=function(){return g&&g.mapId},e.loadMap=function(a,d){var g=function(b){var c=b&&b.loaded||0,d=b&&b.total||1,e=b&&b.loaded?Math.round(100*c/d)+"%":b;f("mapLoading",a,e)},h=function(b,i){var k=function(){f("mapLoading",a),c.loadMap(a,!0).then(j,h,g)},l=c.description?" ["+c.description+"]":"";"no-access-allowed"===b?f("mapLoadingUnAuthorized",a,b):"failed-authentication"===b?f("authorisationFailed",c.description,k):"not-authenticated"===b?f("authRequired",c.description,k):"map-load-redirect"===b?e.loadMap(i,d):"user-cancel"===b?f("mapLoadingCancelled"):(i=i?i+l:l,f("mapLoadingFailed",a,b,i))};return a!==this.currentMapId()||d?!d&&b?void f("mapLoadingConfirmationRequired",a):(c=i(a))?(f("mapLoading",a),void c.loadMap(a).then(j,h,g)):void f("mapIdNotRecognised",a):void f("mapLoadingCancelled",a)},this.publishMap=function(a){var h=function(a,c){var h=d&&d.reloadOnSave;c=c||{},d=c,b=!1,g.mapId=a,f("mapSaved",a,g.idea,c),(h||c.reloadOnSave)&&e.loadMap(a,!0)},j=function(a){var b=a&&a.loaded||0,d=a&&a.total||1,e=a&&a.loaded?Math.round(100*b/d)+"%":a;f("mapSaving",c.description,e)},k=function(a,b){var d=function(){f("mapSaving",c.description),c.saveMap(g.idea,g.mapId,!0).then(h,k,j)},e=c.description||"";b=b?b+e:e,"no-access-allowed"===a?f("mapSavingUnAuthorized",function(){f("mapSaving",c.description,"Creating a new file"),c.saveMap(g.idea,"new",!0).then(h,k,j)}):"failed-authentication"===a?f("authorisationFailed",b,d):"not-authenticated"===a?f("authRequired",b,d):"file-too-large"===a?f("mapSavingTooLarge",c.description):"user-cancel"===a?f("mapSavingCancelled"):f("mapSavingFailed",a,b)};c=i(a||g.mapId),f("mapSaving",c.description),c.saveMap(g.idea,g.mapId).then(h,k,j)}},MM.MapController.activityTracking=function(a,b){"use strict";var c,d,e=function(a){return 1===a.id},f=function(a){return a.title&&-1===a.title.search(/MindMup|Lancelot|cunning|brilliant|Press Space|famous|Luke|daddy/)},g=function(a){return!f(a)},h=function(a){return e(a)&&a.find(f).length>5&&a.find(g).length<3},i=!1;a.addEventListener("mapLoaded",function(a,e){b.log("Map","View",a),c=h(e),d!==e&&(d=e,e.addEventListener("changed",function(a,c){i||(i=!0,b.log("Map","Edit")),b.log(["Map",a].concat(c))}))}),a.addEventListener("mapLoadingFailed",function(a,c,d){var e="Error loading map document ["+a+"] "+JSON.stringify(c);d&&(e=e+" label ["+d+"]"),b.error(e)}),a.addEventListener("mapSaving",b.log.bind(b,"Map","Save Attempted")),a.addEventListener("mapSaved",function(a,d){i=!1,h(d)&&!c?b.log("Map","Created Relevant",a):c?b.log("Map","Saved Relevant",a):b.log("Map","Saved Irrelevant",a)}),a.addEventListener("mapSavingFailed",function(a,c){b.error("Map save failed ("+c+")"+JSON.stringify(a))}),a.addEventListener("networkError",function(a){b.log("Map","networkError",JSON.stringify(a))})},MM.MapController.alerts=function(a,b,c){"use strict";var d,e=function(a,e,f,g){b.hide(d),c.showModalToConfirm("Please confirm",a,e).then(f,g)},f=function(a,c){b.hide(d),d=b.show(a,c,"error")};a.addEventListener("mapLoadingConfirmationRequired",function(b){e("There are unsaved changes in the current map. Please confirm that you would like to "+("new"===b?"create a new map":"load a different map."),"new"===b?"Create New":"Load anyway",function(){a.loadMap(b,!0)})}),a.addEventListener("mapLoading",function(a,c){b.hide(d),d=b.show('<i class="icon-spinner icon-spin"></i>&nbsp;Please wait, loading the map...',c||"")}),a.addEventListener("mapSaving",function(a,c){b.hide(d),d=b.show('<i class="icon-spinner icon-spin"></i>&nbsp;Please wait, saving the map...',c||"")}),a.addEventListener("authRequired",function(a,b){e("This operation requires authentication through "+a+', an external storage provider. Please click on Authenticate below to go to the external provider and allow MindMup to access your account. You can learn more about authentication requirements on our <a href="http://blog.mindmup.com/p/storage-options.html" target="_blank">Storage Options</a> page.',"Authenticate",b)}),a.addEventListener("mapSaved mapLoaded",function(){b.hide(d)}),a.addEventListener("authorisationFailed",function(a,b){e("The operation was rejected by "+a+" storage. Click on Reauthenticate to try using different credentials or license.","Reauthenticate",b)}),a.addEventListener("mapLoadingUnAuthorized",function(){f("The map could not be loaded.","You do not have the right to view this map")}),a.addEventListener("mapSavingUnAuthorized",function(a){e("You do not have the right to edit this map","Save a copy",a)}),a.addEventListener("mapLoadingFailed",function(a,b,c){f("Unfortunately, there was a problem loading the map."+c,'If you are not experiencing network problems, <a href="http://blog.mindmup.com/p/how-to-resolve-common-networking.html" target="blank">click here for some common ways to fix this</a>')}),a.addEventListener("mapSavingCancelled mapLoadingCancelled",function(){b.hide(d)}),a.addEventListener("mapSavingTooLarge",function(b){"S3_CORS"===b?e('The map is too large for anonymous MindMup storage. Maps larger than 100 KB can only be stored to MindMup Gold, or a third-party cloud storage. (<a href="http://blog.mindmup.com/p/storage-options.html" target="_blank">more info on storage options</a>)',"Save to MindMup Gold",function(){a.publishMap("b")},function(){a.dispatchEvent("mapSavingCancelled")}):f("Unfortunately, the file is too large for the selected storage.","Please select a different storage provider from File -&gt; Save As menu")}),a.addEventListener("mapSavingFailed",function(a,b,c){var d={"network-error":["There was a network problem communicating with the server.",'If you are not experiencing network problems, <a href="http://blog.mindmup.com/p/how-to-resolve-common-networking.html" target="blank">click here for some common ways to fix this</a>. Don\'t worry, you have an auto-saved version in this browser profile that will be loaded the next time you open the map']},g=d[a]||["Unfortunately, there was a problem saving the map.","Please try again later. We have sent an error report and we will look into this as soon as possible"];c?e(g[0],g[1],c):f(g[0],g[1])})},function(){"use strict";var a=jQuery.ajaxSettings.xhr.bind(jQuery.ajaxSettings);jQuery.ajaxSettings.xhr=function(){var b=a();return b instanceof XMLHttpRequest&&b.addEventListener("progress",this.progress,!1),b.upload&&b.upload.addEventListener("progress",this.progress,!1),b}}(),MM.MeasuresModel=function(a,b,c){"use strict";var d,e,f=observable(this),g=[],h=[],i=function(){var b=d&&d.getAttr(a);return _.isArray(b)?b:[]},j=function(a){var b={};return _.each(a,function(a){b[a.id]=a}),b},k=function(a,b){var c=[];return _.each(a.values,function(d,e){var f=b&&b.values&&b.values[e]||0;d!==f&&c.push(["measureValueChanged",a.id,e,d||0])}),b&&_.each(b.values,function(d,e){var f=!a||!a.values||!a.values[e];f&&c.push(["measureValueChanged",b.id,e,0])}),c},l=function(a,b){var c=j(b),d=[];return _.each(a,function(a){var b=c[a.id];d=d.concat(k(a,b))}),d},m=function(){if(0!==f.listeners("measureValueChanged").length){var a=h,b=l(f.getMeasurementValues(),a);_.each(b,function(a){f.dispatchEvent.apply(f,a)})}},n=function(){var a=g;g=i(),f.listeners("measureRemoved").length>0&&_.each(_.difference(a,g),function(a){f.dispatchEvent("measureRemoved",a)}),f.listeners("measureAdded").length>0&&_.each(_.difference(g,a),function(a){f.dispatchEvent("measureAdded",a,g.indexOf(a))}),m()};c.addEventListener("mapLoaded",function(a,b){d&&d.removeEventListener("changed",n),d=b,g=i(),d.addEventListener("changed",n)}),f.getMeasures=function(){return g.slice(0)},f.editWithFilter=function(a){e=a,f.dispatchEvent("measuresEditRequested")},f.getMeasurementValues=function(){if(!d)return[];var a=[];return d.traverse(function(c){(!e||e(c))&&a.push({id:c.id,title:c.title,values:_.extend({},c.getAttr(b))})}),h=a.slice(0),a},f.addMeasure=function(b){return b&&""!==b.trim()?(b=b.trim(),_.find(g,function(a){return a.toUpperCase()===b.toUpperCase()})?!1:void d.updateAttr(d.id,a,g.concat([b]))):!1},f.removeMeasure=function(c){if(!c||""===c.trim())return!1;var e=_.without(g,c);_.isEqual(e,g)||(d.startBatch(),d.updateAttr(d.id,a,e),d.traverse(function(a){d.mergeAttrProperty(a.id,b,c,!1)}),d.endBatch())},f.validate=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},f.setValue=function(a,c,e){return f.validate(e)?d.mergeAttrProperty(a,b,c,e):!1},f.getRawData=function(){var a=[];return d?(a.push(["Name"].concat(g)),d.traverse(function(c){(!e||e(c))&&a.push([c.title].concat(_.map(g,function(a){var d=c.getAttr(b)||{};return d[a]})))}),a):a},f.removeFilter=function(){e=void 0}},MM.MeasuresModel.filterByIds=function(a){"use strict";return function(b){return _.include(a,b.id)}},jQuery.fn.editByActivatedNodesWidget=function(a,b,c){"use strict";return jQuery.each(this,function(){var d=jQuery(this),e=function(){b.getInputEnabled()&&c.editWithFilter(MM.MeasuresModel.filterByIds(b.getActivatedNodeIds()))};d.keydown(a,e).find("[data-mm-role=activatedNodesMeasureSheet]").click(e)})},jQuery.fn.addToRowAtIndex=function(a,b){"use strict";var c=jQuery(this),d=a.children("[data-mm-role="+c.data("mm-role")+"]").eq(b);return d.length?c.insertBefore(d):c.appendTo(a),c},jQuery.fn.numericTotaliser=function(){"use strict";var a=jQuery(this),b=a.find("tfoot tr"),c=function(c){var d=0;0!==c&&(a.find("tbody tr").each(function(){var a=jQuery(this);d+=parseFloat(a.children().eq(c).text())}),b.children().eq(c).text(d))},d=function(){var a;for(a=1;a<b.children().size();a++)c(a)};return a.on("change",function(a,b){var e=jQuery(a.target);void 0!==b?c(b):e.is("td")?c(e.index()):d()}),this},jQuery.fn.modalMeasuresSheetWidget=function(a){"use strict";return jQuery.each(this,function(){var b=jQuery(this),c=b.find("[data-mm-role=measurements-table]"),d=b.find("[data-mm-role=no-measures]"),e=b.find("[data-mm-role=measurement-template]"),f=e.parent(),g=b.find("[data-mm-role=idea-template]"),h=g.find("[data-mm-role=value-template]").detach(),i=g.parent(),j=b.find("[data-mm-role=measure-to-add]"),k=b.find("[data-mm-role=summary-template]"),l=k.parent(),m=function(a){return b.find('[data-mm-nodeid="'+a+'"]')},n=function(a){return _.map(f.children(),function(a){return jQuery(a).find("[data-mm-role=measurement-name]").text()}).indexOf(a)},o=function(b,g){var h=e.clone().addToRowAtIndex(f,g);h.find("[data-mm-role=measurement-name]").text(b),h.find("[data-mm-role=remove-measure]").click(function(){a.removeMeasure(b)}),k.clone().addToRowAtIndex(l,g).text("0"),c.show(),d.hide()},p=function(b,c,d,e,f){var g=b.children("[data-mm-role=value-template]").eq(f),i=h.clone();return i.text(c||"0").on("change",function(b,c){return a.setValue(d,e,c)}),g.length?i.insertBefore(g):i.appendTo(b),i},q=function(a,b,d){var e=m(a),f=n(b);f>=0&&(e.children().eq(f).text(d),c.trigger("change",f))},r=function(a,b){o(a,b),_.each(i.children(),function(c){p(jQuery(c),"0",jQuery(c).data("mm-nodeid"),a,b)})},s=function(a){var b=n(a);0>b||(f.children().eq(b).remove(),l.children().eq(b).remove(),_.each(i.children(),function(a){jQuery(a).children().eq(b).remove()}))};e.detach(),k.detach(),g.detach(),c.editableTableWidget({editor:b.find("[data-mm-role=measures-editor]"),cloneProperties:jQuery.fn.editableTableWidget.defaultOptions.cloneProperties.concat(["outline","box-shadow","-webkit-box-shadow","-moz-box-shadow"])}).on("validate",function(b,c){return a.validate(c)
}).numericTotaliser(),b.on("shown",function(){b.find("[data-mm-role=measure-to-add]").focus(),b.find("[data-mm-role=measurements-table] td").first().focus()}),b.on("show",function(){f.children("[data-mm-role=measurement-template]").remove(),l.children("[data-mm-role=summary-template]").remove();var e=a.getMeasures();e&&e.length>0?(c.show(),d.hide()):(c.hide(),d.show()),_.each(e,function(a){o(a)}),i.children("[data-mm-role=idea-template]").remove(),_.each(a.getMeasurementValues(),function(a){var b=g.clone().appendTo(i).attr("data-mm-nodeid",a.id);b.find("[data-mm-role=idea-title]").text(function(){var b=jQuery(this).data("mm-truncate");return b&&a.title.length>b?a.title.substring(0,b)+"...":a.title}),_.each(e,function(c){p(b,a.values[c],a.id,c)})}),b.find("[data-mm-role=measurements-table]").trigger("change"),a.addEventListener("measureValueChanged",q),a.addEventListener("measureAdded",r),a.addEventListener("measureRemoved",s)}),b.on("hide",function(){a.removeEventListener("measureValueChanged",q),a.removeEventListener("measureAdded",r),a.removeEventListener("measureRemoved",s),a.removeFilter()}),b.modal({keyboard:!0,show:!1}),a.addEventListener("measuresEditRequested",function(){b.modal("show")}),b.find("[data-mm-role=measure-to-add]").parent("form").on("submit",function(){return a.addMeasure(j.val()),j.val(""),!1})})},MM.navigationDelimiters=",;#",MM.navigationEscape=function(a,b){"use strict";if(!a)return a;var c="["+MM.navigationDelimiters+"]+",d=new RegExp(c,"g");return b=b||"_",a.replace(d,b)},MM.navigation=function(a,b){"use strict";var c=this,d="nil",e="[Mm]:([^"+MM.navigationDelimiters+"]*)",f=new RegExp(e),g=function(){var a=window&&window.location&&window.location.hash,b=a&&f.exec(a);return b&&b[1]},h=function(a){window.location.hash=f.test(window.location.hash)?window.location.hash.replace(f,"m:"+a):window.location.hash&&"#"!==window.location.hash?window.location.hash+",m:"+a:"m:"+a},i=function(b){return b&&a.setItem("mostRecentMapLoaded",b),b=b||d,h(b),!0};return c.initialMapId=function(){var b=g();return b&&b!==d||(b=a&&a.getItem&&a.getItem("mostRecentMapLoaded")),b},c.loadInitial=function(){var a=c.initialMapId();return b.loadMap(a||"new"),a},b.addEventListener("mapSaved mapLoaded mapLoadingCancelled",function(a){i(a)}),c.hashChange=function(){var a=g();if(a!==d)return a?(b.loadMap(a),!0):(i(b.currentMapId()),!1)},window.addEventListener("hashchange",c.hashChange),c},MM.OfflineAdapter=function(a){"use strict";var b={editable:!0};this.description="OFFLINE",this.recognises=function(a){return a&&"o"===a[0]},this.loadMap=function(c){var d=jQuery.Deferred(),e=a.load(c);return e?d.resolve(e,c,"application/json",b):d.reject("not-found"),d.promise()},this.saveMap=function(c,d,e){var f=jQuery.Deferred(),g={QuotaExceededError:"file-too-large",NS_ERROR_DOM_QUOTA_REACHED:"file-too-large",QUOTA_EXCEEDED_ERR:"file-too-large"};try{e=e.replace(/\.mup$/,""),this.recognises(d)?(a.save(d,c,e),f.resolve(d,b)):f.resolve(a.saveNew(c,e),b)}catch(h){var i=g[h.name];i?f.reject(i):f.reject("local-storage-failed",h.toString()).promise()}return f.promise()}},MM.OfflineMapStorage=function(a,b){"use strict";observable(this),b=b||"offline";var c=this.dispatchEvent,d=b+"-maps",e=function(a){return{d:a,t:Math.round(+new Date/1e3)}},f=function(a){return b+"-map-"+a},g=function(){var b=a.getItem(d)||{nextMapId:1,maps:{}};return b.maps=b.maps||{},b},h=function(b,c,f,g){g=g||c.title||JSON.parse(c).title,f.maps[b]=e(g),a.setItem(b,{map:c}),a.setItem(d,f)};return this.save=function(a,b,c){h(a,b,g(),c)},this.saveNew=function(a,b){var c=g(),d=f(c.nextMapId);return c.nextMapId++,h(d,a,c,b),d},this.remove=function(b){var e=g();a.remove(b),delete e.maps[b],a.setItem(d,e),c("mapDeleted",b)},this.restore=function(b,e,f){var h=g();h.maps[b]=f,a.setItem(b,{map:e}),a.setItem(d,h),c("mapRestored",b,e,f)},this.list=function(){return g().maps},this.load=function(b){var c=a.getItem(b);return c&&c.map},this},MM.OfflineMapStorageBookmarks=function(a,b){"use strict";a.addEventListener("mapRestored",function(a,c,d){b.store({mapId:a,title:d.d})}),a.addEventListener("mapDeleted",function(a){b.remove(a,!0)})},MM.retry=function(a,b,c){"use strict";var d=jQuery.Deferred(),e=function(){a().then(d.resolve,function(){!b||b.apply(void 0,arguments)?(d.notify("Network problem... Will retry shortly"),c?setTimeout(e,c()):e()):d.reject.apply(void 0,arguments)},d.notify)};return e(),d.promise()},MM.retryTimes=function(a){"use strict";return function(){return a--}},MM.linearBackoff=function(){"use strict";var a=0;return function(){return a++,1e3*a}},MM.RetriableMapSourceDecorator=function(a){"use strict";var b=function(a){var b=MM.retryTimes(a);return function(a){return b()&&"network-error"===a}};this.loadMap=function(c,d){return MM.retry(a.loadMap.bind(a,c,d),b(5),MM.linearBackoff())},this.saveMap=function(c,d,e){return MM.retry(a.saveMap.bind(a,c,d,e),b(5),MM.linearBackoff())},this.description=a.description,this.recognises=a.recognises,this.autoSave=a.autoSave},MM.S3Api=function(){"use strict";var a=this;this.save=function(a,b,c){var d=new FormData,e=c&&c.isPrivate?"bucket-owner-read":"public-read",f=jQuery.Deferred(),g=function(a){var b,c,d,e={EntityTooLarge:"file-too-large"};if(403===a.status)return void f.reject("failed-authentication");try{b=a&&(a.responseXML||jQuery.parseXML(a.responseText)),c=jQuery(b).find("Error Code").text()}catch(g){}return c?(d=jQuery(b).find("Error Message").text(),void f.reject(e[c],d)):void f.reject("network-error")};return["key","AWSAccessKeyId","policy","signature"].forEach(function(a){d.append(a,b[a])}),d.append("acl",e),d.append("Content-Type","text/plain"),d.append("file",a),jQuery.ajax({url:"https://"+b.s3BucketName+".s3.amazonaws.com/",type:"POST",processData:!1,contentType:!1,data:d}).then(f.resolve,g),f.promise()},a.pollerDefaults={sleepPeriod:1e3,timeoutPeriod:2e4},a.poll=function(b,c){var d,e,f=jQuery.Deferred(),g=function(){return f&&!(c.stoppedSemaphore&&c.stoppedSemaphore())},h=function(){var a=function(){g()&&(c.sleepTimeoutId=window.setTimeout(h,c.sleepPeriod))};g()?jQuery.ajax({url:b,timeout:c.sleepPeriod,method:"GET"}).then(function(b){var c=jQuery(b).find("Contents Key").first().text();f&&c?(window.clearTimeout(e),f.resolve(c)):a()},a):window.clearTimeout(e)},i=function(){g()&&f.reject("polling-timeout"),window.clearTimeout(d),f=void 0};return c=_.extend(a.pollerDefaults,c),g()&&(e=window.setTimeout(i,c.timeoutPeriod),h()),f.promise()},a.loadUrl=function(a){var b=jQuery.Deferred();return jQuery.ajax(a,{cache:!1}).then(b.resolve,function(a){b.reject(404===a.status||403===a.status?"map-not-found":"network-error")}),b.promise()}},MM.S3ConfigGenerator=function(a,b,c){"use strict";this.generate=function(){var c=jQuery.Deferred(),d={url:b,dataType:"json",type:"POST",processData:!1,contentType:!1};return jQuery.ajax(d).then(function(b){b.s3Url=a,b.mapId=b.s3UploadIdentifier,c.resolve(b)},c.reject.bind(c,"network-error")),c.promise()},this.buildMapUrl=function(b){return jQuery.Deferred().resolve(a+c+b+".json").promise()}},MM.S3FileSystem=function(a,b,c){"use strict";var d={editable:!0},e=new MM.S3Api;this.description=c,this.prefix=b,this.recognises=function(a){return a&&a[0]===b},this.loadMap=function(c,f){var g=jQuery.Deferred(),h=function(a){g.resolve(a,c,"application/json",d)};return a.buildMapUrl(c,b,f).then(function(a){e.loadUrl(a).then(h,g.reject)},g.reject),g.promise()},this.saveMap=function(c,f,g,h){var i=jQuery.Deferred(),j=function(a){e.save(c,a,{isPrivate:!1}).then(function(){i.resolve(a.mapId,_.extend(a,d))},i.reject)};return a.generate(f,g,b,h).then(j,i.reject),i.promise()}},jQuery.fn.scoreWidget=function(a,b,c,d,e,f){"use strict";return this.each(function(){var g,h=jQuery(this),i=function(){var b=h.find("button.active").val();return b?(a.log("Score","send-modal"),a.log("Score",b,h.find("[name=why]").val()),h.modal("hide")):h.find("button").effect("pulsate"),!1},j=function(a){var b=new Date(a),c=b.getDate(),d=b.getMonth()+1,e=b.getFullYear();return String("")+e+(9>=d?"0"+d:d)+(9>=c?"0"+c:c)},k=function(){var c=Date.now();d[e]||f!=j(c)||(a.log("Score","show-modal-alert"),g=b.show("Please help us improve!",'<a data-toggle="modal" data-target="#modalScore">Click here to answer one very quick question</a>, we would appreciate that very much',"warning"),d[e]=c)};h.on("show",function(){a.log("Score","show-modal"),g&&b.hide(g),h.find("button").removeClass("active"),h.find("[name=why]").val("")}),h.find("[data-mm-role=send]").click(i),h.find("form").submit(i),setTimeout(k,1e3*c)})},jQuery.fn.scoreAlertWidget=function(a,b,c,d,e,f){"use strict";return this.each(function(){var g,h,i=jQuery(this).html(),j=Date.now(),k=function(){var b=g.find("button.active").val();return b?(a.log("Score","send-alert"),a.log("Score",b,g.find("[name=why]").val()),g.hide()):g.find("button").effect("pulsate"),!1},l=function(a){var b=new Date(a),c=b.getDate(),d=b.getMonth()+1,e=b.getFullYear();return String("")+e+(9>=d?"0"+d:d)+(9>=c?"0"+c:c)},m=function(){a.log("Score","show-alert"),h=b.show("Will you visit MindMup again in the next 7 days?",i,"warning"),g=jQuery(".alert-no-"+h),d[e]=j,g.find("form").submit(k)};d[e]||f!=l(j)||setTimeout(m,1e3*c)})},MM.exportIdeas=function(a,b){"use strict";var c=function(a,b,d){d=d||0,a(b,d),_.each(b.sortedSubIdeas(),function(b){c(a,b,d+1)})};return b.begin&&b.begin(),c(b.each,a),b.end&&b.end(),b.contents()},MM.TabSeparatedTextExporter=function(){"use strict";var a=[];this.contents=function(){return a.join("\n")},this.each=function(b,c){a.push(_.map(_.range(c),function(){return"	"}).join("")+b.title.replace(/\t|\n|\r/g," "))}},MM.HtmlTableExporter=function(){"use strict";var a;this.begin=function(){a=$("<table>").wrap("<div></div>")},this.contents=function(){return'<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"> </head><body>'+$(a).parent().html()+"</body></html>"},this.each=function(b,c){var d=$("<tr>").appendTo(a),e=$("<td>").appendTo(d).text(b.title);b.attr&&b.attr.style&&b.attr.style.background&&(e.css("background-color",b.attr.style.background),e.css("color",MAPJS.contrastForeground(b.attr.style.background))),c>0&&$("<td>").prependTo(d).html("&nbsp;").attr("colspan",c)}},MM.exportToHtmlDocument=function(a){"use strict";var b=jQuery.Deferred(),c=function(c){var d=$("<div>"),e=function(a,b){MAPJS.URLHelper.containsLink(b)?$("<a>").attr("href",MAPJS.URLHelper.getLink(b)).text(MAPJS.URLHelper.stripLink(b)||b).appendTo(a):a.text(b)},f=function(a,b){var c=b&&b.attr&&b.attr.attachment;c&&"text/html"===c.contentType&&$("<div>").addClass("attachment").appendTo(a).html(c.content)},g=function(a){var b=$("<ul>");return _.each(a,function(a){var c=$("<li>").appendTo(b);e(c,a.title),f(c,a),a.attr&&a.attr.style&&a.attr.style.background&&(c.css("background-color",a.attr.style.background),c.css("color",MAPJS.contrastForeground(a.attr.style.background))),_.isEmpty(a.ideas)||g(a.sortedSubIdeas()).appendTo(c)}),b},h=$("<h1>").appendTo(d);c&&$("<img>").addClass("mapimage").attr("src",c).appendTo(d),e(h,a.title),f(d,a),_.isEmpty(a.ideas)||g(a.sortedSubIdeas()).appendTo(d),b.resolve('<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><style type="text/css">body{font-family:"HelveticaNeue",Helvetica,Arial,sans-serif;font-size:14px;line-height:20px;color:#333333;margin-left:10%;margin-right:10%;}h1{display:block;font-size:38.5px;line-height:40px;font-family:inherit;}li{line-height:20px;padding-left:10px;}ul{list-style-type:none;}div.attachment{border:1px solid black;margin:5px;padding:5px;}img.mapimage{border:1px solid black;max-height:600px;max-width:600px;}</style></head><body>'+$(d).html()+"</body></html>","text/html")};return MAPJS.pngExport(a).then(c),b.promise()},MM.exportTableToText=function(a){"use strict";return _.map(a,function(a){return _.map(a,function(a){return a?a.toString().replace(/\t|\n|\r/g," "):""}).join("	")}).join("\n")},$.fn.toggleClassWidget=function(){"use strict";var a=this;return a.filter("[data-mm-key]").each(function(){var a=$(this);$(window).keydown(a.data("mm-key"),function(b){a.click(),b.preventDefault()})}),a.click(function(){var a=$($(this).data("mm-target")),b=$(this).data("mm-class");a.toggleClass(b)}),a};