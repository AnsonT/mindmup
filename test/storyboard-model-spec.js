/*global describe, it, MM, expect, beforeEach, jasmine, MAPJS, observable*/
describe('Storyboards', function () {
	'use strict';
	var activeContent, mapController, activeContentListener;
	beforeEach(function () {
		activeContent = MAPJS.content({
			title: 'root',
			id: 1,
			ideas: {
				1: {id: 11, title: 'not in any storyboards'},
			    2: {id: 12, title: 'already in ted storyboard', attr: {'test-scenes': [{storyboards: {'ted talk': 1}}]}},
			    3: {id: 14, title: 'only in bed storyboard', attr: {'test-scenes': [{storyboards: {'ted talk': 10}}]}},
				4: {id: 13, title: 'in two storyboards', attr: {'test-scenes': [{storyboards: {'ted talk': 2, 'bed talk': 1}}]}}
			}
		});
		mapController = observable({});
		activeContentListener = new MM.ActiveContentListener(mapController);

	});

	describe('StoryboardModel', function () {
		var underTest;
		beforeEach(function () {
			underTest = new MM.StoryboardModel(activeContentListener, 'test-storyboards', 'test-scenes');
			mapController.dispatchEvent('mapLoaded', 'loadedMapid', activeContent);
		});
		describe('getActiveStoryboardName', function () {
			it('should return undefined if no storyboards are defined', function () {
				expect(underTest.getActiveStoryboardName()).toBeUndefined();
			});
			it('should return the first storyboard name by default', function () {
				activeContent.updateAttr(1, 'test-storyboards', ['mickey mouse', 'donald duck']);
				expect(underTest.getActiveStoryboardName()).toEqual('mickey mouse');
			});
		});
		describe('setInputEnabled', function () {
			var listener = jasmine.createSpy('listener');
			beforeEach(function () {
				underTest.addEventListener('inputEnabled', listener);
			});
			it('should dispatch an InputEnabled event when true', function () {
				underTest.setInputEnabled(true);
				expect(listener).toHaveBeenCalledWith(true);
			});
			it('should dispatch an InputEnabled event when false', function () {
				underTest.setInputEnabled(false);
				expect(listener).toHaveBeenCalledWith(false);
			});
		});
		describe('getIsInputEnabled', function () {
			it('should be false to begin with', function () {
				expect(underTest.getInputEnabled()).toBeFalsy();
			});
			it('should be true when set', function () {
				underTest.setInputEnabled(true);
				expect(underTest.getInputEnabled()).toBe(true);
			});
		});
		describe('createStoryboard', function () {
			it('should add the new storyboard name to the list of storyboards', function () {
				underTest.createStoryboard();
				expect(activeContent.getAttrById(1, 'test-storyboards')).toEqual(['Storyboard 1']);
			});
			it('should return the new storyboard name', function () {
				expect(underTest.createStoryboard()).toEqual('Storyboard 1');
			});
			it('should make the new storyboard active', function () {
				activeContent.updateAttr(1, 'test-storyboards', ['mickey mouse', 'donald duck']);
				underTest.createStoryboard();
				expect(underTest.getActiveStoryboardName()).toEqual('Storyboard 3');
			});
			it('should name the new storyboard Story Board X, incrementing the counter', function () {
				activeContent.updateAttr(1, 'test-storyboards', ['mickey mouse', 'donald duck']);
				var first = underTest.createStoryboard(),
					second = underTest.createStoryboard();
				expect(first).toBe('Storyboard 3');
				expect(second).toBe('Storyboard 4');
			});
			it('should skip over any counters in the same format as autogenerated, to avoid conflicts', function () {
				activeContent.updateAttr(1, 'test-storyboards', ['Storyboard 5', 'donald duck']);
				expect(underTest.createStoryboard()).toBe('Storyboard 6');
			});
		});
		describe('setActiveStoryboardName', function () {
			it('should change the active storyboard', function () {

			});
			it('dispatches an event to widgets', function () {

			});
		});


		describe('getStoryboards', function () {
			it('should return a list of storyboard names', function () {});
		});
		describe('removeStoryboard', function () {
			it('should remove the new storyboard from the list of storyboards', function () {});
			it('should remove clean all nodes that were scenes in a storyboard', function () {});

		});
		describe('renameStoryboard', function () {
			it('should change the storyboard name in the list of storyboards', function () {});
		});
		describe('cloneStoryboard', function () {
			it('should create a storyboard with a the same scenes as the cloned storyboard', function () {
			});
		});
		describe('getStoryBoard', function () {
			it('should return a storyboard matching the supplied name', function () {
				/*
				It is still not clear what a "storyboard" is
				- a list of scenes?
				- a map (containing a list of scenes)?
				- an object that encapsulates behaviour?
				*/
			});
		});
		describe('when a new map is loaded', function () {

		});

		describe('nextSceneIndex', function () {
			it('returns 1 for non existent storyboards', function () {
				expect(underTest.nextSceneIndex('red talk')).toBe(1);
			});
			it('returns max index + 1 for non empty storyboards', function () {
				expect(underTest.nextSceneIndex('ted talk')).toBe(11);
				expect(underTest.nextSceneIndex('bed talk')).toBe(2);
			});
		});
		describe('getScenesForNodeId', function () {
			it('retrieves the value of the scenes attr', function () {
				expect(underTest.getScenesForNodeId(11)).toEqual([]);
				expect(underTest.getScenesForNodeId(12)).toEqual([{storyboards: {'ted talk': 1}}]);
				expect(underTest.getScenesForNodeId(13)).toEqual([{storyboards: {'ted talk': 2, 'bed talk': 1}}]);
			});
		});
		describe('setScenesForNodeId', function () {
			it('sets the value of the scenes attr', function () {
				underTest.setScenesForNodeId(12, [{storyboards: {'xed talk': 5}}]);
				expect(activeContent.getAttrById(12, 'test-scenes')).toEqual([{storyboards: {'xed talk': 5}}]);
			});
		});
		describe('insertionIndexAfter', function () {
			it('calculates the arithmetic median if the index is not the last in the list', function () {
				expect(underTest.insertionIndexAfter('ted talk', 1)).toBe(1.5);
				expect(underTest.insertionIndexAfter('ted talk', 2)).toBe(6);
			});
			it('calculates the arithmetic median between 0 and the first item if the index is undefined', function () {
				expect(underTest.insertionIndexAfter('ted talk')).toBe(0.5);
			});
			it('adds 1 to the max index if the argument is the last in the list', function () {
				expect(underTest.insertionIndexAfter('ted talk', 10)).toBe(11);
			});
			it('returns false if the index is not in the list', function () {
				expect(underTest.insertionIndexAfter('ted talk', 11)).toBeFalsy();
			});
		});
		describe('getScenesForStoryboard', function () {
			it('retrieves a list of scenes for the specified storyboard', function () {
				expect(underTest.getScenes('ted talk')).toEqual([
					{ideaId: 12, title: 'already in ted storyboard', index: 1},
					{ideaId: 13, title: 'in two storyboards', index: 2},
					{ideaId: 14, title: 'only in bed storyboard', index: 10}
				]);
			});
			it('returns an empty array for a non existing story board', function () {
				expect(underTest.getScenes('xed talk')).toEqual([]);
			});
		});
	});

	describe('StoryboardController', function () {
		var underTest, storyboardModel;
		beforeEach(function () {
			storyboardModel = new jasmine.createSpyObj('storyboardModel', ['getActiveStoryboardName', 'getScenes', 'createStoryboard', 'getScenesForNodeId', 'insertionIndexAfter', 'setScenesForNodeId', 'nextSceneIndex']);
			underTest = new MM.StoryboardController(storyboardModel);
		});
		describe('when active content is not loaded', function () {
			it('addScene should return false', function () {
				expect(underTest.addScene(1)).toBeFalsy();
			});
			it('getScenes should return empty array', function () {
				expect(underTest.getScenes()).toEqual([]);
			});
		});
		describe('when activeContent has been loaded', function () {
			beforeEach(function () {
				mapController.dispatchEvent('mapLoaded', 'loadedMapid', activeContent);
			});

			describe('addScene', function () {
				describe('when no story boards exist', function () {
					beforeEach(function () {
						storyboardModel.getActiveStoryboardName.and.returnValue(undefined);
						storyboardModel.createStoryboard.and.returnValue('newname');
						underTest.addScene(12);
					});
					it('should create a default story board if no story boards exist for the map', function () {
						expect(storyboardModel.createStoryboard).toHaveBeenCalled();
					});
					it('should add a scene to an empty storyboard as the first scene', function () {
						expect(storyboardModel.setScenesForNodeId).toHaveBeenCalledWith(12, [{storyboards: {newname: 1}}]);
					});
				});
				describe('when the active storyboard exists but is blank', function () {
					beforeEach(function () {
						storyboardModel.getActiveStoryboardName.and.returnValue('red talk');
						storyboardModel.getScenesForNodeId.and.returnValue([]);
						storyboardModel.nextSceneIndex.and.returnValue(1);
					});
					it('should not try to create a new storyboard', function () {
						underTest.addScene(11);
						expect(storyboardModel.createStoryboard).not.toHaveBeenCalled();
					});
					it('should add a scene to the end of a storyboard if storyboard is currently empty', function () {
						underTest.addScene(11);
						expect(storyboardModel.setScenesForNodeId).toHaveBeenCalledWith(11, [{storyboards: {'red talk': 1}}]);
					});
					it('should keep any other scenes for other storyboards intact', function () {
						storyboardModel.getScenesForNodeId.and.returnValue([{storyboards: {'ted talk': 1}}]);
						underTest.addScene(12);
						expect(storyboardModel.setScenesForNodeId).toHaveBeenCalledWith(12, [
							{storyboards: {'ted talk': 1}},
							{storyboards: {'red talk': 1}}
						]);
					});
				});
				describe('when the active storyboard exists but is not blank', function () {
					beforeEach(function () {
						storyboardModel.getScenesForNodeId.and.returnValue([]);
						storyboardModel.getActiveStoryboardName.and.returnValue('ted talk');
						storyboardModel.nextSceneIndex.and.returnValue(11);
						storyboardModel.insertionIndexAfter.and.returnValue(6);
					});
					it('should not try to create a new storyboard', function () {
						underTest.addScene(11);
						expect(storyboardModel.createStoryboard).not.toHaveBeenCalled();
					});
					it('should add a scene to the end if optional index supplied ', function () {
						underTest.addScene(11);
						expect(storyboardModel.setScenesForNodeId).toHaveBeenCalledWith(11, [{storyboards: {'ted talk': 11}}]);
					});
					it('should insert the scene after the optional specified index', function () {
						underTest.addScene(11, 2);
						expect(storyboardModel.insertionIndexAfter).toHaveBeenCalledWith('ted talk', 2);
						expect(storyboardModel.setScenesForNodeId).toHaveBeenCalledWith(11, [{storyboards: {'ted talk': 6}}]);
					});
					it('should keep any other scenes for other storyboards intact', function () {
						storyboardModel.getScenesForNodeId.and.returnValue([{storyboards: {'ted talk': 1}}]);
						underTest.addScene(12);
						expect(storyboardModel.setScenesForNodeId).toHaveBeenCalledWith(12, [
							{storyboards: {'ted talk': 1}},
							{storyboards: {'ted talk': 11}}
						]);
					});
				});
			});
			describe('getScenes', function () {
				beforeEach(function () {
					storyboardModel.getActiveStoryboardName.and.returnValue('ted talk');
					storyboardModel.getScenes.and.returnValue([
						{ideaId: 12, title: 'already in ted storyboard', index: 1},
						{ideaId: 13, title: 'in two storyboards', index: 2},
						{ideaId: 14, title: 'only in bed storyboard', index: 10}
					]);
				});
				it('retrieves a list of scenes for the currently active storyboard', function () {
					expect(underTest.getScenes()).toEqual([
						{ideaId: 12, title: 'already in ted storyboard', index: 1},
						{ideaId: 13, title: 'in two storyboards', index: 2},
						{ideaId: 14, title: 'only in bed storyboard', index: 10}
					]);
					expect(storyboardModel.getScenes).toHaveBeenCalledWith('ted talk');
				});
			});
			describe('moveSceneAfter', function () {
				var firstScene, middleScene, lastScene;
				beforeEach(function () {
					firstScene = {ideaId: 12, title: 'the first scene', index: 1};
					middleScene = {ideaId: 13, title: 'the middle scene', index: 2};
					lastScene = {ideaId: 14, title: 'the last scene', index: 3};
					storyboardModel.getActiveStoryboardName.and.returnValue('ted talk');
					storyboardModel.getScenes.and.returnValue([
						firstScene,
						middleScene,
						lastScene
					]);
				});
				it('should move before the first scene first if no scene to move before is supplied', function () {
					storyboardModel.insertionIndexAfter.and.returnValue(0.5);
					storyboardModel.getScenesForNodeId.and.returnValue([{storyboards: {'ted talk': 2}}]);
					expect(underTest.moveSceneAfter(middleScene)).toBeTruthy();
					expect(storyboardModel.setScenesForNodeId).toHaveBeenCalledWith(13, [{storyboards: {'ted talk': 0.5}}]);
				});
				it('should move the scene after the specified scene ', function () {
					storyboardModel.insertionIndexAfter.and.returnValue(4);
					storyboardModel.getScenesForNodeId.and.returnValue([{storyboards: {'ted talk': 2}}]);
					expect(underTest.moveSceneAfter(middleScene, lastScene)).toBeTruthy();
					expect(storyboardModel.setScenesForNodeId).toHaveBeenCalledWith(13, [{storyboards: {'ted talk': 4}}]);
				});
				describe('should do nothing and return false when scenes effectively stay in the same position because', function () {
					it('there is no active storyboard', function () {
						storyboardModel.getActiveStoryboardName.and.returnValue(undefined);
						expect(underTest.moveSceneAfter(middleScene, firstScene)).toBeFalsy();
						expect(storyboardModel.setScenesForNodeId).not.toHaveBeenCalled();
					});
					it('the scenes to be moved is undefined', function () {
						expect(underTest.moveSceneAfter(undefined, firstScene)).toBeFalsy();
						expect(storyboardModel.getScenesForNodeId).not.toHaveBeenCalled();
						expect(storyboardModel.setScenesForNodeId).not.toHaveBeenCalled();
					});

					it('the scenes are already in the correct order', function () {
						expect(underTest.moveSceneAfter(middleScene, firstScene)).toBeFalsy();
						expect(storyboardModel.getScenesForNodeId).not.toHaveBeenCalled();
						expect(storyboardModel.setScenesForNodeId).not.toHaveBeenCalled();
					});
					it('the scenes is moved after itself', function () {
						expect(underTest.moveSceneAfter(middleScene, middleScene)).toBeFalsy();
						expect(storyboardModel.getScenesForNodeId).not.toHaveBeenCalled();
						expect(storyboardModel.setScenesForNodeId).not.toHaveBeenCalled();
					});
					it('the scenes is moved first when it is already first', function () {
						expect(underTest.moveSceneAfter(firstScene)).toBeFalsy();
						expect(storyboardModel.getScenesForNodeId).not.toHaveBeenCalled();
						expect(storyboardModel.setScenesForNodeId).not.toHaveBeenCalled();
					});
					it('the scenes to be moved does not exist in storyboard', function () {
						storyboardModel.getScenesForNodeId.and.returnValue([{storyboards: {'ted talk': 2}}]);
						expect(underTest.moveSceneAfter({ideaId: 13, title: 'the middle scene', index: 2.5}, firstScene)).toBeFalsy();
						expect(storyboardModel.setScenesForNodeId).not.toHaveBeenCalled();
					});
				});
			});
			describe('removeScene', function () {
				beforeEach(function () {
					storyboardModel.getActiveStoryboardName.and.returnValue('ted talk');
					storyboardModel.getScenesForNodeId.and.returnValue([
						{storyboards: {'ted talk': 1, 'red talk': 1}},
						{storyboards: {'ted talk': 4}}
					]);
				});
				it('should remove only the specified scene', function () {

					underTest.removeScene({ideaId: 2, index: 1});

					expect(storyboardModel.getScenesForNodeId).toHaveBeenCalledWith(2);
					expect(storyboardModel.setScenesForNodeId).toHaveBeenCalledWith(2, [
						{storyboards: {'red talk': 1}},
						{storyboards: {'ted talk': 4}}
					]);
				});
				it('should clean up when the last storyboard scene is removed', function () {
					underTest.removeScene({ideaId: 2, index: 4});

					expect(storyboardModel.getScenesForNodeId).toHaveBeenCalledWith(2);
					expect(storyboardModel.setScenesForNodeId).toHaveBeenCalledWith(2, [
						{storyboards: {'ted talk': 1, 'red talk': 1}},
					]);

				});
				it('should return false if no scene to remove is supplied', function () {
					expect(underTest.removeScene()).toBeFalsy();
					expect(storyboardModel.setScenesForNodeId).not.toHaveBeenCalled();
				});
				it('should return false if no storyboard is active', function () {
					storyboardModel.getActiveStoryboardName.and.returnValue(undefined);
					expect(underTest.removeScene({ideaId: 2, index: 1})).toBeFalsy();
					expect(storyboardModel.setScenesForNodeId).not.toHaveBeenCalled();
				});
				it('should return false if scene to remove is nonsense', function () {
					expect(underTest.removeScene({'bleurh': '2'})).toBeFalsy();
					expect(storyboardModel.setScenesForNodeId).not.toHaveBeenCalled();
				});
			});
			describe('should reorganise the scene if the scene index precision is more than 8 significant figures', function () {
				it('when a scene is added', function () {});
				it('when a scene is moved', function () {});
				it('when a scene is inserted', function () {});
			});
			describe('when there are listeners', function () {
				describe('should reflect changes made to the map', function () {
					describe('should remove scenes related to a node when it is deleted', function () {

					});
					describe('should fire scene-added when a scene is added through active content', function () {

					});
					describe('should fire scene-removed when a scene is removed through active content', function () {

					});
					describe('should react to the active storyboard being renamed', function () {
						// also fire an event for widgets!
					});
				});
			});
			describe('when there are no listeners', function () {
				describe('should ignore changes to the map', function () {

				});
			});
			describe('should react to the loaded map being changed', function () {
				it('activates the first story board if there are any', function () {

				});
				it('removes the active storyboard if previous map had story boards and new map does not', function () {

				});
			});
		});

	});
});
